"use strict";var Bt=Object.defineProperty;var vs=Object.getOwnPropertyDescriptor;var ws=Object.getOwnPropertyNames;var bs=Object.prototype.hasOwnProperty;var xs=(r,e)=>{for(var t in e)Bt(r,t,{get:e[t],enumerable:!0})},Ms=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ws(e))!bs.call(r,s)&&s!==t&&Bt(r,s,{get:()=>e[s],enumerable:!(n=vs(e,s))||n.enumerable});return r};var Ss=r=>Ms(Bt({},"__esModule",{value:!0}),r);var oo={};xs(oo,{default:()=>Ht});module.exports=Ss(oo);var fs=require("obsidian");var re="0.39.0";var Rn=!1,oe,Ut,Cs,Es,_s,Pn,Rs,Qe,jt,Tn,qt,Ze,An;function kn(r,e={auto:!1}){if(Rn)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${r.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(oe)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${r.kind}'\` after \`import '@anthropic-ai/sdk/shims/${oe}'\``);Rn=e.auto,oe=r.kind,Ut=r.fetch,Cs=r.Request,Es=r.Response,_s=r.Headers,Pn=r.FormData,Rs=r.Blob,Qe=r.File,jt=r.ReadableStream,Tn=r.getMultipartRequestOptions,qt=r.getDefaultAgent,Ze=r.fileFromPath,An=r.isFsReadStream}var et=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function In({manuallyImported:r}={}){let e=r?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n",t,n,s,o;try{t=fetch,n=Request,s=Response,o=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:s,Headers:o,FormData:typeof FormData!="undefined"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob!="undefined"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File!="undefined"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream!="undefined"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,a)=>({...a,body:new et(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:i=>!1}}oe||kn(In(),{auto:!0});var f=class extends Error{},E=class r extends f{constructor(e,t,n,s){super(`${r.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.request_id=s==null?void 0:s["request-id"],this.error=t}static makeMessage(e,t,n){let s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new Q({message:n,cause:tt(t)});let o=t;return e===400?new Se(e,o,n,s):e===401?new Ce(e,o,n,s):e===403?new Ee(e,o,n,s):e===404?new _e(e,o,n,s):e===409?new Re(e,o,n,s):e===422?new Pe(e,o,n,s):e===429?new Te(e,o,n,s):e>=500?new Ae(e,o,n,s):new r(e,o,n,s)}},R=class extends E{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},Q=class extends E{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},me=class extends Q{constructor({message:e}={}){super({message:e!=null?e:"Request timed out."})}},Se=class extends E{},Ce=class extends E{},Ee=class extends E{},_e=class extends E{},Re=class extends E{},Pe=class extends E{},Te=class extends E{},Ae=class extends E{};var nt=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},ie=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},F,z=class{constructor(){F.set(this,void 0),this.buffer=new Uint8Array,nt(this,F,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e,n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer),n.set(t,this.buffer.length),this.buffer=n;let s=[],o;for(;(o=As(this.buffer,ie(this,F,"f")))!=null;){if(o.carriage&&ie(this,F,"f")==null){nt(this,F,o.index,"f");continue}if(ie(this,F,"f")!=null&&(o.index!==ie(this,F,"f")+1||o.carriage)){s.push(this.decodeText(this.buffer.slice(0,ie(this,F,"f")-1))),this.buffer=this.buffer.slice(ie(this,F,"f")),nt(this,F,null,"f");continue}let i=ie(this,F,"f")!==null?o.preceding-1:o.preceding,a=this.decodeText(this.buffer.slice(0,i));s.push(a),this.buffer=this.buffer.slice(o.index),nt(this,F,null,"f")}return s}decodeText(e){var t;if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer!="undefined"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new f(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder!="undefined"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return(t=this.textDecoder)!=null||(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new f(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new f("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};F=new WeakMap;z.NEWLINE_CHARS=new Set([`
`,"\r"]);z.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function As(r,e){for(let s=e!=null?e:0;s<r.length;s++){if(r[s]===10)return{preceding:s,index:s+1,carriage:!1};if(r[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function Ln(r){for(let n=0;n<r.length-1;n++){if(r[n]===10&&r[n+1]===10||r[n]===13&&r[n+1]===13)return n+2;if(r[n]===13&&r[n+1]===10&&n+3<r.length&&r[n+2]===13&&r[n+3]===10)return n+4}return-1}function ke(r){if(r[Symbol.asyncIterator])return r;let e=r.getReader();return{async next(){try{let t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var j=class r{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*s(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let o=!1;try{for await(let i of ks(e,t)){if(i.event==="completion")try{yield JSON.parse(i.data)}catch(a){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),a}if(i.event==="message_start"||i.event==="message_delta"||i.event==="message_stop"||i.event==="content_block_start"||i.event==="content_block_delta"||i.event==="content_block_stop")try{yield JSON.parse(i.data)}catch(a){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),a}if(i.event!=="ping"&&i.event==="error")throw E.generate(void 0,`SSE Error: ${i.data}`,i.data,zt(e.headers))}o=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{o||t.abort()}}return new r(s,t)}static fromReadableStream(e,t){let n=!1;async function*s(){let i=new z,a=ke(e);for await(let l of a)for(let d of i.decode(l))yield d;for(let l of i.flush())yield l}async function*o(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(let a of s())i||a&&(yield JSON.parse(a));i=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{i||t.abort()}}return new r(o,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],n=this.iterator(),s=o=>({next:()=>{if(o.length===0){let i=n.next();e.push(i),t.push(i)}return o.shift()}});return[new r(()=>s(e),this.controller),new r(()=>s(t),this.controller)]}toReadableStream(){let e=this,t,n=new TextEncoder;return new jt({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{let{value:o,done:i}=await t.next();if(i)return s.close();let a=n.encode(JSON.stringify(o)+`
`);s.enqueue(a)}catch(o){s.error(o)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}};async function*ks(r,e){if(!r.body)throw e.abort(),new f("Attempted to iterate over a response with no body");let t=new Wt,n=new z,s=ke(r.body);for await(let o of Is(s))for(let i of n.decode(o)){let a=t.decode(i);a&&(yield a)}for(let o of n.flush()){let i=t.decode(o);i&&(yield i)}}async function*Is(r){let e=new Uint8Array;for await(let t of r){if(t==null)continue;let n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,s=new Uint8Array(e.length+n.length);s.set(e),s.set(n,e.length),e=s;let o;for(;(o=Ln(e))!==-1;)yield e.slice(0,o),e=e.slice(o)}e.length>0&&(yield e)}var Wt=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let o={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],o}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=Ls(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}};function Ls(r,e){let t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}var $s=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",Fs=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&Ie(r),Ie=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function";async function $n(r,e,t){var s,o,i;if(r=await r,Fs(r))return r;if($s(r)){let a=await r.blob();e||(e=(s=new URL(r.url).pathname.split(/[\\/]/).pop())!=null?s:"unknown_file");let l=Ie(a)?[await a.arrayBuffer()]:[a];return new Qe(l,e,t)}let n=await Ds(r);if(e||(e=(o=Ns(r))!=null?o:"unknown_file"),!(t!=null&&t.type)){let a=(i=n[0])==null?void 0:i.type;typeof a=="string"&&(t={...t,type:a})}return new Qe(n,e,t)}async function Ds(r){var t;let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(Ie(r))e.push(await r.arrayBuffer());else if(Os(r))for await(let n of r)e.push(n);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${(t=r==null?void 0:r.constructor)==null?void 0:t.name}; props: ${Hs(r)}`);return e}function Hs(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function Ns(r){var e;return Vt(r.name)||Vt(r.filename)||((e=Vt(r.path))==null?void 0:e.split(/[\\/]/).pop())}var Vt=r=>{if(typeof r=="string")return r;if(typeof Buffer!="undefined"&&r instanceof Buffer)return String(r)},Os=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",Gt=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody";var Us=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},js=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},st;async function Nn(r){let{response:e}=r;if(r.options.stream)return he("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):j.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;let t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){let o=await e.json();return he("response",e.status,e.url,e.headers,o),On(o,e)}let s=await e.text();return he("response",e.status,e.url,e.headers,s),s}function On(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var it=class r extends Promise{constructor(e,t=Nn){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new r(this.responsePromise,async t=>On(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},at=class{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:s,fetch:o}){this.baseURL=e,this.maxRetries=Xt("maxRetries",t),this.timeout=Xt("timeout",n),this.httpAgent=s,this.fetch=o!=null?o:Ut}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Vs(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Ys()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async s=>{let o=s&&Ie(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:t,...s,body:o}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer!="undefined")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder!="undefined")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var m,g,x,$,A,C;e={...e};let{method:n,path:s,query:o,headers:i={}}=e,a=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:Gt(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,l=this.calculateContentLength(a),d=this.buildURL(s,o);"timeout"in e&&Xt("timeout",e.timeout),e.timeout=(m=e.timeout)!=null?m:this.timeout;let c=(x=(g=e.httpAgent)!=null?g:this.httpAgent)!=null?x:qt(d),p=e.timeout+1e3;typeof(($=c==null?void 0:c.options)==null?void 0:$.timeout)=="number"&&p>((A=c.options.timeout)!=null?A:0)&&(c.options.timeout=p),this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let h=this.buildHeaders({options:e,headers:i,contentLength:l,retryCount:t});return{req:{method:n,...a&&{body:a},headers:h,...c&&{agent:c},signal:(C=e.signal)!=null?C:null},url:d,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:s}){let o={};n&&(o["content-length"]=n);let i=this.defaultHeaders(e);return Hn(o,i),Hn(o,t),Gt(e.body)&&oe!=="node"&&delete o["content-type"],ot(i,"x-stainless-retry-count")===void 0&&ot(t,"x-stainless-retry-count")===void 0&&(o["x-stainless-retry-count"]=String(s)),ot(i,"x-stainless-timeout")===void 0&&ot(t,"x-stainless-timeout")===void 0&&e.timeout&&(o["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(o,t),o}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new f("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,s){return E.generate(e,t,n,s)}request(e,t=null){return new it(this.makeRequest(e,t))}async makeRequest(e,t){var p,h,u;let n=await e,s=(p=n.maxRetries)!=null?p:this.maxRetries;t==null&&(t=s),await this.prepareOptions(n);let{req:o,url:i,timeout:a}=this.buildRequest(n,{retryCount:s-t});if(await this.prepareRequest(o,{url:i,options:n}),he("request",i,n,o.headers),(h=n.signal)!=null&&h.aborted)throw new R;let l=new AbortController,d=await this.fetchWithTimeout(i,o,a,l).catch(tt);if(d instanceof Error){if((u=n.signal)!=null&&u.aborted)throw new R;if(t)return this.retryRequest(n,t);throw d.name==="AbortError"?new me:new Q({cause:d})}let c=zt(d.headers);if(!d.ok){if(t&&this.shouldRetry(d)){let C=`retrying, ${t} attempts remaining`;return he(`response (error; ${C})`,d.status,i,c),this.retryRequest(n,t,c)}let m=await d.text().catch(C=>tt(C).message),g=Gs(m),x=g?void 0:m;throw he(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,d.status,i,c,x),this.makeStatusError(d.status,g,x,c)}return{response:d,options:n,controller:l}}requestAPIList(e,t){let n=this.makeRequest(t,null);return new Kt(this,n,e)}buildURL(e,t){let n=Ks(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return Le(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n!="undefined").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new f(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,s){let{signal:o,...i}=t||{};o&&o.addEventListener("abort",()=>s.abort());let a=setTimeout(()=>s.abort(),n),l={signal:s.signal,...i};l.method&&(l.method=l.method.toUpperCase());let d=60*1e3,c=setTimeout(()=>{var p,h;if(l&&((p=l==null?void 0:l.agent)!=null&&p.sockets))for(let u of Object.values((h=l==null?void 0:l.agent)==null?void 0:h.sockets).flat())u!=null&&u.setKeepAlive&&u.setKeepAlive(!0,d)},d);return this.fetch.call(void 0,e,l).finally(()=>{clearTimeout(a),clearTimeout(c)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){var a;let s,o=n==null?void 0:n["retry-after-ms"];if(o){let l=parseFloat(o);Number.isNaN(l)||(s=l)}let i=n==null?void 0:n["retry-after"];if(i&&!s){let l=parseFloat(i);Number.isNaN(l)?s=Date.parse(i)-Date.now():s=l*1e3}if(!(s&&0<=s&&s<60*1e3)){let l=(a=e.maxRetries)!=null?a:this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,l)}return await Js(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let o=t-e,i=Math.min(.5*Math.pow(2,o),8),a=1-Math.random()*.25;return i*a*1e3}getUserAgent(){return`${this.constructor.name}/JS ${re}`}},ct=class{constructor(e,t,n,s){st.set(this,void 0),Us(this,st,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new f("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[s,o]of n)e.url.searchParams.set(s,o);t.query=void 0,t.path=e.url.toString()}return await js(this,st,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(st=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},Kt=class extends it{constructor(e,t,n){super(t,async s=>new n(e,s.response,await Nn(s),s.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},zt=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){let n=t.toString();return e[n.toLowerCase()]||e[n]}}),qs={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},N=r=>typeof r=="object"&&r!==null&&!Le(r)&&Object.keys(r).every(e=>Bn(qs,e)),Ws=()=>{var e,t;if(typeof Deno!="undefined"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":re,"X-Stainless-OS":Dn(Deno.build.os),"X-Stainless-Arch":Fn(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:(t=(e=Deno.version)==null?void 0:e.deno)!=null?t:"unknown"};if(typeof EdgeRuntime!="undefined")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":re,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process!="undefined"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":re,"X-Stainless-OS":Dn(process.platform),"X-Stainless-Arch":Fn(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let r=zs();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":re,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":re,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function zs(){if(typeof navigator=="undefined"||!navigator)return null;let r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of r){let n=t.exec(navigator.userAgent);if(n){let s=n[1]||0,o=n[2]||0,i=n[3]||0;return{browser:e,version:`${s}.${o}.${i}`}}}return null}var Fn=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",Dn=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown"),rt,Vs=()=>rt!=null?rt:rt=Ws(),Gs=r=>{try{return JSON.parse(r)}catch(e){return}},Xs=/^[a-z][a-z0-9+.-]*:/i,Ks=r=>Xs.test(r),Js=r=>new Promise(e=>setTimeout(e,r)),Xt=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new f(`${r} must be an integer`);if(e<0)throw new f(`${r} must be a positive integer`);return e},tt=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch(e){}return new Error(String(r))};var lt=r=>{var e,t,n,s,o,i;if(typeof process!="undefined")return(n=(t=(e=process.env)==null?void 0:e[r])==null?void 0:t.trim())!=null?n:void 0;if(typeof Deno!="undefined")return(i=(o=(s=Deno.env)==null?void 0:s.get)==null?void 0:o.call(s,r))==null?void 0:i.trim()};function Le(r){if(!r)return!0;for(let e in r)return!1;return!0}function Bn(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function Hn(r,e){for(let t in e){if(!Bn(e,t))continue;let n=t.toLowerCase();if(!n)continue;let s=e[t];s===null?delete r[n]:s!==void 0&&(r[n]=s)}}function he(r,...e){var t;typeof process!="undefined"&&((t=process==null?void 0:process.env)==null?void 0:t.DEBUG)==="true"&&console.log(`Anthropic:DEBUG:${r}`,...e)}var Ys=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),Un=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined",Qs=r=>typeof(r==null?void 0:r.get)=="function";var ot=(r,e)=>{var n;let t=e.toLowerCase();if(Qs(r)){let s=((n=e[0])==null?void 0:n.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(o,i,a)=>i+a.toUpperCase());for(let o of[e,t,e.toUpperCase(),s]){let i=r.get(o);if(i)return i}}for(let[s,o]of Object.entries(r))if(s.toLowerCase()===t)return Array.isArray(o)?(o.length<=1||console.warn(`Received ${o.length} entries for the ${e} header, using the first entry.`),o[0]):o};var q=class extends ct{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.has_more=n.has_more||!1,this.first_id=n.first_id||null,this.last_id=n.last_id||null}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var t;if((t=this.options.query)!=null&&t.before_id){let n=this.first_id;return n?{params:{before_id:n}}:null}let e=this.last_id;return e?{params:{after_id:e}}:null}};var _=class{constructor(e){this._client=e}};var ae=class extends _{retrieve(e,t){return this._client.get(`/v1/models/${e}?beta=true`,t)}list(e={},t){return N(e)?this.list({},e):this._client.getAPIList("/v1/models?beta=true",fe,{query:e,...t})}},fe=class extends q{};ae.BetaModelInfosPage=fe;var ge=class r{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new z;for await(let t of this.iterator)for(let n of e.decode(t))yield JSON.parse(n);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new f("Attempted to iterate over a response with no body");return new r(ke(e.body),t)}};var ce=class extends _{create(e,t){let{betas:n,...s}=e;return this._client.post("/v1/messages/batches?beta=true",{body:s,...t,headers:{"anthropic-beta":[...n!=null?n:[],"message-batches-2024-09-24"].toString(),...t==null?void 0:t.headers}})}retrieve(e,t={},n){if(N(t))return this.retrieve(e,{},t);let{betas:s}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...n,headers:{"anthropic-beta":[...s!=null?s:[],"message-batches-2024-09-24"].toString(),...n==null?void 0:n.headers}})}list(e={},t){if(N(e))return this.list({},e);let{betas:n,...s}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",ye,{query:s,...t,headers:{"anthropic-beta":[...n!=null?n:[],"message-batches-2024-09-24"].toString(),...t==null?void 0:t.headers}})}delete(e,t={},n){if(N(t))return this.delete(e,{},t);let{betas:s}=t;return this._client.delete(`/v1/messages/batches/${e}?beta=true`,{...n,headers:{"anthropic-beta":[...s!=null?s:[],"message-batches-2024-09-24"].toString(),...n==null?void 0:n.headers}})}cancel(e,t={},n){if(N(t))return this.cancel(e,{},t);let{betas:s}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...n,headers:{"anthropic-beta":[...s!=null?s:[],"message-batches-2024-09-24"].toString(),...n==null?void 0:n.headers}})}async results(e,t={},n){if(N(t))return this.results(e,{},t);let s=await this.retrieve(e);if(!s.results_url)throw new f(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);let{betas:o}=t;return this._client.get(s.results_url,{...n,headers:{"anthropic-beta":[...o!=null?o:[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...n==null?void 0:n.headers},__binaryResponse:!0})._thenUnwrap((i,a)=>ge.fromResponse(a.response,a.controller))}},ye=class extends q{};ce.BetaMessageBatchesPage=ye;var nr=r=>{let e=0,t=[];for(;e<r.length;){let n=r[e];if(n==="\\"){e++;continue}if(n==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(n==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(n==="["){t.push({type:"paren",value:"["}),e++;continue}if(n==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(n===":"){t.push({type:"separator",value:":"}),e++;continue}if(n===","){t.push({type:"delimiter",value:","}),e++;continue}if(n==='"'){let a="",l=!1;for(n=r[++e];n!=='"';){if(e===r.length){l=!0;break}if(n==="\\"){if(e++,e===r.length){l=!0;break}a+=n+r[e],n=r[++e]}else a+=n,n=r[++e]}n=r[++e],l||t.push({type:"string",value:a});continue}if(n&&/\s/.test(n)){e++;continue}let o=/[0-9]/;if(n&&o.test(n)||n==="-"||n==="."){let a="";for(n==="-"&&(a+=n,n=r[++e]);n&&o.test(n)||n===".";)a+=n,n=r[++e];t.push({type:"number",value:a});continue}let i=/[a-z]/i;if(n&&i.test(n)){let a="";for(;n&&i.test(n)&&e!==r.length;)a+=n,n=r[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},ve=r=>{if(r.length===0)return r;let e=r[r.length-1];switch(e.type){case"separator":return r=r.slice(0,r.length-1),ve(r);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return r=r.slice(0,r.length-1),ve(r);case"string":let n=r[r.length-2];if((n==null?void 0:n.type)==="delimiter")return r=r.slice(0,r.length-1),ve(r);if((n==null?void 0:n.type)==="brace"&&n.value==="{")return r=r.slice(0,r.length-1),ve(r);break;case"delimiter":return r=r.slice(0,r.length-1),ve(r);break}return r},sr=r=>{let e=[];return r.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?r.push({type:"brace",value:"}"}):t==="]"&&r.push({type:"paren",value:"]"})}),r},rr=r=>{let e="";return r.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},ut=r=>JSON.parse(rr(sr(ve(nr(r)))));var P=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},y=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},O,Z,$e,dt,Fe,De,pt,He,V,Ne,mt,ht,we,ft,gt,Jt,jn,Yt,Qt,Zt,en,qn,Wn="__json_buf",yt=class r{constructor(){O.add(this),this.messages=[],this.receivedMessages=[],Z.set(this,void 0),this.controller=new AbortController,$e.set(this,void 0),dt.set(this,()=>{}),Fe.set(this,()=>{}),De.set(this,void 0),pt.set(this,()=>{}),He.set(this,()=>{}),V.set(this,{}),Ne.set(this,!1),mt.set(this,!1),ht.set(this,!1),we.set(this,!1),ft.set(this,void 0),gt.set(this,void 0),Yt.set(this,e=>{if(P(this,mt,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new R),e instanceof R)return P(this,ht,!0,"f"),this._emit("abort",e);if(e instanceof f)return this._emit("error",e);if(e instanceof Error){let t=new f(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new f(String(e)))}),P(this,$e,new Promise((e,t)=>{P(this,dt,e,"f"),P(this,Fe,t,"f")}),"f"),P(this,De,new Promise((e,t)=>{P(this,pt,e,"f"),P(this,He,t,"f")}),"f"),y(this,$e,"f").catch(()=>{}),y(this,De,"f").catch(()=>{})}get response(){return y(this,ft,"f")}get request_id(){return y(this,gt,"f")}async withResponse(){let e=await y(this,$e,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,n){let s=new r;for(let o of t.messages)s._addMessageParam(o);return s._run(()=>s._createMessage(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},y(this,Yt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){var a;let s=n==null?void 0:n.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),y(this,O,"m",Qt).call(this);let{response:o,data:i}=await e.create({...t,stream:!0},{...n,signal:this.controller.signal}).withResponse();this._connected(o);for await(let l of i)y(this,O,"m",Zt).call(this,l);if((a=i.controller.signal)!=null&&a.aborted)throw new R;y(this,O,"m",en).call(this)}_connected(e){this.ended||(P(this,ft,e,"f"),P(this,gt,e==null?void 0:e.headers.get("request-id"),"f"),y(this,dt,"f").call(this,e),this._emit("connect"))}get ended(){return y(this,Ne,"f")}get errored(){return y(this,mt,"f")}get aborted(){return y(this,ht,"f")}abort(){this.controller.abort()}on(e,t){return(y(this,V,"f")[e]||(y(this,V,"f")[e]=[])).push({listener:t}),this}off(e,t){let n=y(this,V,"f")[e];if(!n)return this;let s=n.findIndex(o=>o.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(y(this,V,"f")[e]||(y(this,V,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{P(this,we,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){P(this,we,!0,"f"),await y(this,De,"f")}get currentMessage(){return y(this,Z,"f")}async finalMessage(){return await this.done(),y(this,O,"m",Jt).call(this)}async finalText(){return await this.done(),y(this,O,"m",jn).call(this)}_emit(e,...t){if(y(this,Ne,"f"))return;e==="end"&&(P(this,Ne,!0,"f"),y(this,pt,"f").call(this));let n=y(this,V,"f")[e];if(n&&(y(this,V,"f")[e]=n.filter(s=>!s.once),n.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!y(this,we,"f")&&!(n!=null&&n.length)&&Promise.reject(s),y(this,Fe,"f").call(this,s),y(this,He,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!y(this,we,"f")&&!(n!=null&&n.length)&&Promise.reject(s),y(this,Fe,"f").call(this,s),y(this,He,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",y(this,O,"m",Jt).call(this))}async _fromReadableStream(e,t){var o;let n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),y(this,O,"m",Qt).call(this),this._connected(null);let s=j.fromReadableStream(e,this.controller);for await(let i of s)y(this,O,"m",Zt).call(this,i);if((o=s.controller.signal)!=null&&o.aborted)throw new R;y(this,O,"m",en).call(this)}[(Z=new WeakMap,$e=new WeakMap,dt=new WeakMap,Fe=new WeakMap,De=new WeakMap,pt=new WeakMap,He=new WeakMap,V=new WeakMap,Ne=new WeakMap,mt=new WeakMap,ht=new WeakMap,we=new WeakMap,ft=new WeakMap,gt=new WeakMap,Yt=new WeakMap,O=new WeakSet,Jt=function(){if(this.receivedMessages.length===0)throw new f("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},jn=function(){if(this.receivedMessages.length===0)throw new f("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(n=>n.type==="text").map(n=>n.text);if(t.length===0)throw new f("stream ended without producing a content block with type=text");return t.join(" ")},Qt=function(){this.ended||P(this,Z,void 0,"f")},Zt=function(t){var s;if(this.ended)return;let n=y(this,O,"m",qn).call(this,t);switch(this._emit("streamEvent",t,n),t.type){case"content_block_delta":{let o=n.content.at(-1);switch(t.delta.type){case"text_delta":{o.type==="text"&&this._emit("text",t.delta.text,o.text||"");break}case"citations_delta":{o.type==="text"&&this._emit("citation",t.delta.citation,(s=o.citations)!=null?s:[]);break}case"input_json_delta":{o.type==="tool_use"&&o.input&&this._emit("inputJson",t.delta.partial_json,o.input);break}case"thinking_delta":{o.type==="thinking"&&this._emit("thinking",t.delta.thinking,o.thinking);break}case"signature_delta":{o.type==="thinking"&&this._emit("signature",o.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(n),this._addMessage(n,!0);break}case"content_block_stop":{this._emit("contentBlock",n.content.at(-1));break}case"message_start":{P(this,Z,n,"f");break}case"content_block_start":case"message_delta":break}},en=function(){if(this.ended)throw new f("stream has ended, this shouldn't happen");let t=y(this,Z,"f");if(!t)throw new f("request ended without sending any chunks");return P(this,Z,void 0,"f"),t},qn=function(t){var s;let n=y(this,Z,"f");if(t.type==="message_start"){if(n)throw new f(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!n)throw new f(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return n;case"message_delta":return n.stop_reason=t.delta.stop_reason,n.stop_sequence=t.delta.stop_sequence,n.usage.output_tokens=t.usage.output_tokens,n;case"content_block_start":return n.content.push(t.content_block),n;case"content_block_delta":{let o=n.content.at(t.index);switch(t.delta.type){case"text_delta":{(o==null?void 0:o.type)==="text"&&(o.text+=t.delta.text);break}case"citations_delta":{(o==null?void 0:o.type)==="text"&&((s=o.citations)!=null||(o.citations=[]),o.citations.push(t.delta.citation));break}case"input_json_delta":{if((o==null?void 0:o.type)==="tool_use"){let i=o[Wn]||"";i+=t.delta.partial_json,Object.defineProperty(o,Wn,{value:i,enumerable:!1,writable:!0}),i&&(o.input=ut(i))}break}case"thinking_delta":{(o==null?void 0:o.type)==="thinking"&&(o.thinking+=t.delta.thinking);break}case"signature_delta":{(o==null?void 0:o.type)==="thinking"&&(o.signature=t.delta.signature);break}default:t.delta}return n}case"content_block_stop":return n}},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("streamEvent",s=>{let o=t.shift();o?o.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(let o of t)o.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(let o of t)o.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((o,i)=>t.push({resolve:o,reject:i})).then(o=>o?{value:o,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new j(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var zn={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"},ee=class extends _{constructor(){super(...arguments),this.batches=new ce(this._client)}create(e,t){var o,i;let{betas:n,...s}=e;return s.model in zn&&console.warn(`The model '${s.model}' is deprecated and will reach end-of-life on ${zn[s.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:s,timeout:(o=this._client._options.timeout)!=null?o:s.stream?6e5:this._client._calculateNonstreamingTimeout(s.max_tokens),...t,headers:{...(n==null?void 0:n.toString())!=null?{"anthropic-beta":n==null?void 0:n.toString()}:void 0,...t==null?void 0:t.headers},stream:(i=e.stream)!=null?i:!1})}stream(e,t){return yt.createMessage(this,e,t)}countTokens(e,t){let{betas:n,...s}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:s,...t,headers:{"anthropic-beta":[...n!=null?n:[],"token-counting-2024-11-01"].toString(),...t==null?void 0:t.headers}})}};ee.Batches=ce;ee.BetaMessageBatchesPage=ye;var W=class extends _{constructor(){super(...arguments),this.models=new ae(this._client),this.messages=new ee(this._client)}};W.Models=ae;W.BetaModelInfosPage=fe;W.Messages=ee;var le=class extends _{create(e,t){var n,s;return this._client.post("/v1/complete",{body:e,timeout:(n=this._client._options.timeout)!=null?n:6e5,...t,stream:(s=e.stream)!=null?s:!1})}};var ue=class extends _{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/v1/messages/batches/${e}`,t)}list(e={},t){return N(e)?this.list({},e):this._client.getAPIList("/v1/messages/batches",be,{query:e,...t})}delete(e,t){return this._client.delete(`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let n=await this.retrieve(e);if(!n.results_url)throw new f(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);return this._client.get(n.results_url,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})._thenUnwrap((s,o)=>ge.fromResponse(o.response,o.controller))}},be=class extends q{};ue.MessageBatchesPage=be;var T=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},v=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},B,te,Oe,vt,Be,Ue,wt,je,G,qe,bt,xt,xe,Mt,St,tn,Vn,nn,sn,rn,on,Gn,Xn="__json_buf",Ct=class r{constructor(){B.add(this),this.messages=[],this.receivedMessages=[],te.set(this,void 0),this.controller=new AbortController,Oe.set(this,void 0),vt.set(this,()=>{}),Be.set(this,()=>{}),Ue.set(this,void 0),wt.set(this,()=>{}),je.set(this,()=>{}),G.set(this,{}),qe.set(this,!1),bt.set(this,!1),xt.set(this,!1),xe.set(this,!1),Mt.set(this,void 0),St.set(this,void 0),nn.set(this,e=>{if(T(this,bt,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new R),e instanceof R)return T(this,xt,!0,"f"),this._emit("abort",e);if(e instanceof f)return this._emit("error",e);if(e instanceof Error){let t=new f(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new f(String(e)))}),T(this,Oe,new Promise((e,t)=>{T(this,vt,e,"f"),T(this,Be,t,"f")}),"f"),T(this,Ue,new Promise((e,t)=>{T(this,wt,e,"f"),T(this,je,t,"f")}),"f"),v(this,Oe,"f").catch(()=>{}),v(this,Ue,"f").catch(()=>{})}get response(){return v(this,Mt,"f")}get request_id(){return v(this,St,"f")}async withResponse(){let e=await v(this,Oe,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,n){let s=new r;for(let o of t.messages)s._addMessageParam(o);return s._run(()=>s._createMessage(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),s}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},v(this,nn,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){var a;let s=n==null?void 0:n.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),v(this,B,"m",sn).call(this);let{response:o,data:i}=await e.create({...t,stream:!0},{...n,signal:this.controller.signal}).withResponse();this._connected(o);for await(let l of i)v(this,B,"m",rn).call(this,l);if((a=i.controller.signal)!=null&&a.aborted)throw new R;v(this,B,"m",on).call(this)}_connected(e){this.ended||(T(this,Mt,e,"f"),T(this,St,e==null?void 0:e.headers.get("request-id"),"f"),v(this,vt,"f").call(this,e),this._emit("connect"))}get ended(){return v(this,qe,"f")}get errored(){return v(this,bt,"f")}get aborted(){return v(this,xt,"f")}abort(){this.controller.abort()}on(e,t){return(v(this,G,"f")[e]||(v(this,G,"f")[e]=[])).push({listener:t}),this}off(e,t){let n=v(this,G,"f")[e];if(!n)return this;let s=n.findIndex(o=>o.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(v(this,G,"f")[e]||(v(this,G,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{T(this,xe,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){T(this,xe,!0,"f"),await v(this,Ue,"f")}get currentMessage(){return v(this,te,"f")}async finalMessage(){return await this.done(),v(this,B,"m",tn).call(this)}async finalText(){return await this.done(),v(this,B,"m",Vn).call(this)}_emit(e,...t){if(v(this,qe,"f"))return;e==="end"&&(T(this,qe,!0,"f"),v(this,wt,"f").call(this));let n=v(this,G,"f")[e];if(n&&(v(this,G,"f")[e]=n.filter(s=>!s.once),n.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!v(this,xe,"f")&&!(n!=null&&n.length)&&Promise.reject(s),v(this,Be,"f").call(this,s),v(this,je,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!v(this,xe,"f")&&!(n!=null&&n.length)&&Promise.reject(s),v(this,Be,"f").call(this,s),v(this,je,"f").call(this,s),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",v(this,B,"m",tn).call(this))}async _fromReadableStream(e,t){var o;let n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),v(this,B,"m",sn).call(this),this._connected(null);let s=j.fromReadableStream(e,this.controller);for await(let i of s)v(this,B,"m",rn).call(this,i);if((o=s.controller.signal)!=null&&o.aborted)throw new R;v(this,B,"m",on).call(this)}[(te=new WeakMap,Oe=new WeakMap,vt=new WeakMap,Be=new WeakMap,Ue=new WeakMap,wt=new WeakMap,je=new WeakMap,G=new WeakMap,qe=new WeakMap,bt=new WeakMap,xt=new WeakMap,xe=new WeakMap,Mt=new WeakMap,St=new WeakMap,nn=new WeakMap,B=new WeakSet,tn=function(){if(this.receivedMessages.length===0)throw new f("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Vn=function(){if(this.receivedMessages.length===0)throw new f("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(n=>n.type==="text").map(n=>n.text);if(t.length===0)throw new f("stream ended without producing a content block with type=text");return t.join(" ")},sn=function(){this.ended||T(this,te,void 0,"f")},rn=function(t){var s;if(this.ended)return;let n=v(this,B,"m",Gn).call(this,t);switch(this._emit("streamEvent",t,n),t.type){case"content_block_delta":{let o=n.content.at(-1);switch(t.delta.type){case"text_delta":{o.type==="text"&&this._emit("text",t.delta.text,o.text||"");break}case"citations_delta":{o.type==="text"&&this._emit("citation",t.delta.citation,(s=o.citations)!=null?s:[]);break}case"input_json_delta":{o.type==="tool_use"&&o.input&&this._emit("inputJson",t.delta.partial_json,o.input);break}case"thinking_delta":{o.type==="thinking"&&this._emit("thinking",t.delta.thinking,o.thinking);break}case"signature_delta":{o.type==="thinking"&&this._emit("signature",o.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(n),this._addMessage(n,!0);break}case"content_block_stop":{this._emit("contentBlock",n.content.at(-1));break}case"message_start":{T(this,te,n,"f");break}case"content_block_start":case"message_delta":break}},on=function(){if(this.ended)throw new f("stream has ended, this shouldn't happen");let t=v(this,te,"f");if(!t)throw new f("request ended without sending any chunks");return T(this,te,void 0,"f"),t},Gn=function(t){var s;let n=v(this,te,"f");if(t.type==="message_start"){if(n)throw new f(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!n)throw new f(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return n;case"message_delta":return n.stop_reason=t.delta.stop_reason,n.stop_sequence=t.delta.stop_sequence,n.usage.output_tokens=t.usage.output_tokens,n;case"content_block_start":return n.content.push(t.content_block),n;case"content_block_delta":{let o=n.content.at(t.index);switch(t.delta.type){case"text_delta":{(o==null?void 0:o.type)==="text"&&(o.text+=t.delta.text);break}case"citations_delta":{(o==null?void 0:o.type)==="text"&&((s=o.citations)!=null||(o.citations=[]),o.citations.push(t.delta.citation));break}case"input_json_delta":{if((o==null?void 0:o.type)==="tool_use"){let i=o[Xn]||"";i+=t.delta.partial_json,Object.defineProperty(o,Xn,{value:i,enumerable:!1,writable:!0}),i&&(o.input=ut(i))}break}case"thinking_delta":{(o==null?void 0:o.type)==="thinking"&&(o.thinking+=t.delta.thinking);break}case"signature_delta":{(o==null?void 0:o.type)==="thinking"&&(o.signature=t.delta.signature);break}default:t.delta}return n}case"content_block_stop":return n}},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("streamEvent",s=>{let o=t.shift();o?o.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(let o of t)o.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(let o of t)o.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((o,i)=>t.push({resolve:o,reject:i})).then(o=>o?{value:o,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new j(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var X=class extends _{constructor(){super(...arguments),this.batches=new ue(this._client)}create(e,t){var n,s;return e.model in Kn&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Kn[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:(n=this._client._options.timeout)!=null?n:e.stream?6e5:this._client._calculateNonstreamingTimeout(e.max_tokens),...t,stream:(s=e.stream)!=null?s:!1})}stream(e,t){return Ct.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},Kn={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};X.Batches=ue;X.MessageBatchesPage=be;var ne=class extends _{retrieve(e,t){return this._client.get(`/v1/models/${e}`,t)}list(e={},t){return N(e)?this.list({},e):this._client.getAPIList("/v1/models",de,{query:e,...t})}},de=class extends q{};ne.ModelInfosPage=de;var Jn,w=class extends at{constructor({baseURL:e=lt("ANTHROPIC_BASE_URL"),apiKey:t=(o=>(o=lt("ANTHROPIC_API_KEY"))!=null?o:null)(),authToken:n=(i=>(i=lt("ANTHROPIC_AUTH_TOKEN"))!=null?i:null)(),...s}={}){var l;let a={apiKey:t,authToken:n,...s,baseURL:e||"https://api.anthropic.com"};if(!a.dangerouslyAllowBrowser&&Un())throw new f(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:a.baseURL,timeout:(l=a.timeout)!=null?l:6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new le(this),this.messages=new X(this),this.models=new ne(this),this.beta=new W(this),this._options=a,this.apiKey=t,this.authToken=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"])&&t["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&t.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){let t=this.apiKeyAuth(e),n=this.bearerAuth(e);return t!=null&&!Le(t)?t:n!=null&&!Le(n)?n:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}};Jn=w;w.Anthropic=Jn;w.HUMAN_PROMPT=`

Human:`;w.AI_PROMPT=`

Assistant:`;w.DEFAULT_TIMEOUT=6e5;w.AnthropicError=f;w.APIError=E;w.APIConnectionError=Q;w.APIConnectionTimeoutError=me;w.APIUserAbortError=R;w.NotFoundError=_e;w.ConflictError=Re;w.RateLimitError=Te;w.BadRequestError=Se;w.AuthenticationError=Ce;w.InternalServerError=Ae;w.PermissionDeniedError=Ee;w.UnprocessableEntityError=Pe;w.toFile=$n;w.fileFromPath=Ze;w.Completions=le;w.Messages=X;w.Models=ne;w.ModelInfosPage=de;w.Beta=W;var{HUMAN_PROMPT:Oi,AI_PROMPT:Bi}=w,Et=w;var b=class r extends Error{constructor(t,n,s){super(t);this.code=n;this.retryable=s;this.name="LLMError",Object.setPrototypeOf(this,r.prototype)}static authError(t){return new r(t,"auth_error",!1)}static rateLimit(t){return new r(t,"rate_limit",!0)}static network(t){return new r(t,"network",!0)}static invalidRequest(t){return new r(t,"invalid_request",!1)}static unknown(t){return new r(t,"unknown",!1)}static aborted(t){return new r(t,"aborted",!1)}};function Yn(r){return r.type==="text"}function Qn(r){return r.type==="tool_use"}function an(r){return r.content.filter(Qn).map(e=>({id:e.id,name:e.name,input:e.input}))}function K(r){return r.content.filter(Yn).map(e=>e.text).join(`
`)}var Zn=3,cr=1e3,lr=4096,We=class{constructor(e){this.client=null;this.model=e}async initialize(e){if(!e||typeof e!="string"||e.trim().length===0)throw b.authError("Invalid API key. Please check your Anthropic API key in settings.");this.client=new Et({apiKey:e.trim(),dangerouslyAllowBrowser:!0})}async sendMessage(e,t,n,s){if(!this.client)throw b.authError("Provider not initialized. Call initialize() with API key first.");let o=this.convertMessages(e),i=t?this.convertTools(t):void 0,a=null;for(let l=0;l<Zn;l++)try{let d=await this.client.messages.create({model:this.model,max_tokens:lr,messages:o,...i&&i.length>0&&{tools:i},...n&&{system:n}},{signal:s});return this.convertResponse(d)}catch(d){let c=this.classifyError(d);if(!c.retryable)throw c;if(a=c,l<Zn-1){let p=this.calculateBackoffDelay(l);await this.sleep(p)}}throw a!=null?a:b.unknown("Request failed after retries")}convertMessages(e){return e.map(t=>({role:t.role,content:this.convertMessageContent(t.content)}))}convertMessageContent(e){return typeof e=="string"?e:e.map(t=>{switch(t.type){case"text":return{type:"text",text:t.text};case"tool_use":return{type:"tool_use",id:t.id,name:t.name,input:t.input};case"tool_result":return{type:"tool_result",tool_use_id:t.toolUseId,content:t.content,...t.isError&&{is_error:t.isError}}}})}convertTools(e){return e.map(t=>({name:t.name,description:t.description,input_schema:t.inputSchema}))}convertResponse(e){let t=[];for(let n of e.content)n.type==="text"?t.push({type:"text",text:n.text}):n.type==="tool_use"&&t.push({type:"tool_use",id:n.id,name:n.name,input:n.input});return{content:t,stopReason:this.convertStopReason(e.stop_reason),usage:{inputTokens:e.usage.input_tokens,outputTokens:e.usage.output_tokens}}}convertStopReason(e){switch(e){case"end_turn":return"end_turn";case"tool_use":return"tool_use";case"max_tokens":return"max_tokens";case"stop_sequence":return"stop_sequence";default:return"end_turn"}}classifyError(e){if(e instanceof Et.APIUserAbortError)return b.aborted("Request was cancelled by user.");if(e instanceof Et.APIError){let t=e.status;return t===401?b.authError("Invalid API key. Please check your Anthropic API key in settings."):t===400?b.invalidRequest(`Invalid request: ${e.message||"Check message format and parameters."}`):t===429?b.rateLimit("Rate limited by Anthropic. Please wait and try again."):t>=500&&t<600?new b(`Anthropic server error (${t}). Retrying...`,"unknown",!0):b.unknown(`Anthropic API error: ${e.message}`)}return e instanceof Error?e.message.includes("network")||e.message.includes("ECONNREFUSED")||e.message.includes("ENOTFOUND")||e.message.includes("ETIMEDOUT")||e.message.includes("fetch failed")||e.name==="TypeError"?b.network("Network error connecting to Anthropic. Check your connection."):b.unknown(e.message):b.unknown("An unknown error occurred")}calculateBackoffDelay(e){return cr*Math.pow(2,e)}sleep(e){return new Promise(t=>setTimeout(t,e))}};var es=20,ur=10,J=class{constructor(e,t){this.tools=new Map;this.conversationHistory=[];this.initialized=!1;this.conversationContext="";this.abortController=null;this.waitingForResponse=!1;this.lastQuestionMessage=null;this.waitingForMessageId=null;this.toolCallsInSession=0;this.app=e,this.settings=t,this.provider=new We(t.model)}async initialize(){let e=this.settings.anthropicApiKeyName;if(!e||e.trim().length===0)throw b.authError("Anthropic API key not configured. Please select a secret in SmartHole settings.");let t=this.app.secretStorage.getSecret(e);if(!t||t.trim().length===0)throw b.authError(`API key secret "${e}" not found or empty. Please configure it in Obsidian's secret storage.`);await this.provider.initialize(t),this.initialized=!0}registerTool(e){this.tools.set(e.definition.name,e)}unregisterTool(e){return this.tools.delete(e)}async processMessage(e){var t,n;if(!this.initialized)throw b.authError("LLMService not initialized. Call initialize() first.");this.abortController=new AbortController,this.conversationHistory.push({role:"user",content:e});try{let s=this.getToolDefinitions(),o=this.buildSystemPrompt(),i=await this.provider.sendMessage(this.conversationHistory,s.length>0?s:void 0,o,this.abortController.signal),a=0;for(;i.stopReason==="tool_use"&&a<ur&&!((t=this.abortController)!=null&&t.signal.aborted);){a++,this.conversationHistory.push({role:"assistant",content:i.content});let l=an(i),d=await this.executeToolCalls(l);this.conversationHistory.push({role:"user",content:d}),i=await this.provider.sendMessage(this.conversationHistory,s.length>0?s:void 0,o,this.abortController.signal)}return(n=this.abortController)!=null&&n.signal.aborted?(this.abortController=null,{content:[],stopReason:"end_turn"}):(this.conversationHistory.push({role:"assistant",content:i.content}),this.abortController=null,this.trimHistory(),i)}catch(s){if(this.abortController=null,s instanceof b&&s.code==="aborted")return{content:[],stopReason:"end_turn"};throw s}}clearHistory(){this.conversationHistory=[]}abort(){var e;(e=this.abortController)==null||e.abort(),this.abortController=null}getHistory(){return this.conversationHistory}setConversationContext(e){this.conversationContext=e}isWaitingForUserResponse(){return this.waitingForResponse}getConversationState(){var e,t;return{isWaitingForResponse:this.waitingForResponse,pendingContext:this.waitingForResponse?{originalMessageId:(e=this.waitingForMessageId)!=null?e:"",toolCallsCompleted:this.toolCallsInSession,lastAgentMessage:(t=this.lastQuestionMessage)!=null?t:"",createdAt:new Date().toISOString()}:void 0}}restoreConversationState(e){var t,n,s,o,i,a;this.waitingForResponse=e.isWaitingForResponse,this.lastQuestionMessage=(n=(t=e.pendingContext)==null?void 0:t.lastAgentMessage)!=null?n:null,this.waitingForMessageId=(o=(s=e.pendingContext)==null?void 0:s.originalMessageId)!=null?o:null,this.toolCallsInSession=(a=(i=e.pendingContext)==null?void 0:i.toolCallsCompleted)!=null?a:0}setWaitingForResponse(e,t){this.waitingForResponse=!0,this.lastQuestionMessage=e,this.waitingForMessageId=t}clearWaitingState(){this.waitingForResponse=!1,this.lastQuestionMessage=null,this.waitingForMessageId=null,this.toolCallsInSession=0}getToolDefinitions(){return Array.from(this.tools.values()).map(e=>e.definition)}buildSystemPrompt(){let e=this.settings.informationArchitecture.trim()?`## Information Architecture
${this.settings.informationArchitecture}

`:"",t=this.tools.size>0?`## Available Tools
You have access to tools for manipulating the vault. Use them to fulfill user requests.
`:"",n=this.conversationContext.trim()?`

${this.conversationContext}`:"";return`You are an intelligent assistant managing an Obsidian vault. You help users organize their notes, create new content, and find information.

The current local time is: ${this.formatCurrentLocalTime()}

${e}## Guidelines
- Make best-guess decisions rather than asking for clarification
- When uncertain about file location, use the most logical folder based on the information architecture
- For ambiguous requests, take reasonable action and explain what you did
- Send notifications via SmartHole to inform the user of actions taken
- Be concise in responses; focus on what was done rather than lengthy explanations

${t}${n}`.trim()}formatCurrentLocalTime(){let e=new Date,t=e.toLocaleString(void 0,{weekday:"long",month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}),n=Intl.DateTimeFormat().resolvedOptions().timeZone,s=e.getTimezoneOffset(),o=s<=0?"+":"-",i=Math.abs(s),a=Math.floor(i/60),l=i%60,d=l===0?`UTC${o}${a}`:`UTC${o}${a}:${String(l).padStart(2,"0")}`;return`${t} (${n}, ${d})`}async executeToolCalls(e){var n;let t=[];for(let s of e){if((n=this.abortController)!=null&&n.signal.aborted)break;let o=await this.executeToolCall(s);t.push(o),this.toolCallsInSession++}return t}async executeToolCall(e){let t=this.tools.get(e.name);if(!t)return{type:"tool_result",toolUseId:e.id,content:`Error: Unknown tool "${e.name}"`,isError:!0};try{let n=await t.execute(e.input);return{type:"tool_result",toolUseId:e.id,content:n}}catch(n){let s=n instanceof Error?n.message:"Unknown error occurred";return{type:"tool_result",toolUseId:e.id,content:`Error executing tool "${e.name}": ${s}`,isError:!0}}}trimHistory(){if(this.conversationHistory.length>es){let e=this.conversationHistory.length-es,t=e+e%2;this.conversationHistory=this.conversationHistory.slice(t)}}};function Y(r){let e=r.replace(/\\/g,"/");return e=e.replace(/\/+$/,""),e=e.replace(/^\/+/,""),e}function dr(r){let e=r.replace(/\\/g,"/").replace(/^\/+|\/+$/g,"");return e=e.replace(/[.+^${}()|[\]]/g,"\\$&"),e=e.replace(/\*\*\//g,"{{GLOBSTAR_SLASH}}"),e=e.replace(/\*\*/g,"{{GLOBSTAR}}"),e=e.replace(/\*/g,"[^/]*"),e=e.replace(/\?/g,"[^/]"),e=e.replace(/\{\{GLOBSTAR_SLASH\}\}/g,"(?:.*?/)?"),e=e.replace(/\{\{GLOBSTAR\}\}/g,".*"),new RegExp(`^${e}$`,"i")}function _t(r,e){let t=r.replace(/\\/g,"/").replace(/^\/+/,"");try{return dr(e).test(t)}catch(n){return!1}}function Rt(r,e){if(!e||e.trim().length===0)return{item:null,ambiguous:!1};let t=Y(e),n=r.vault.getFileByPath(t);if(n)return{item:n,ambiguous:!1};let s=t.toLowerCase(),o=[];for(let i of r.vault.getFiles())i.path.toLowerCase()===s&&o.push(i);return o.length===0?{item:null,ambiguous:!1}:o.length===1?{item:o[0],ambiguous:!1}:{item:null,ambiguous:!0}}function Pt(r,e){if(!e||e.trim().length===0)return{item:null,ambiguous:!1};let t=Y(e),n=r.vault.getFolderByPath(t);if(n)return{item:n,ambiguous:!1};let s=t.toLowerCase(),o=[];for(let i of r.vault.getAllLoadedFiles())!("extension"in i)&&i.path.toLowerCase()===s&&o.push(i);return o.length===0?{item:null,ambiguous:!1}:o.length===1?{item:o[0],ambiguous:!1}:{item:null,ambiguous:!0}}var ts=[".obsidian",".smarthole"];function ze(r){let t=Y(r).toLowerCase();return ts.some(n=>t===n||t.startsWith(`${n}/`))}function I(r){if(ze(r)){let t=Y(r).toLowerCase(),n=ts.find(s=>t===s||t.startsWith(`${s}/`));throw new Error(`Access denied: Cannot access files in '${n}/' directory (protected system folder)`)}}var cn=2e3,ns=1e5,pr={name:"read_file",description:"Read the contents of a file from the vault. Returns content with line numbers. Supports optional line range filtering for large files.",inputSchema:{type:"object",properties:{path:{type:"string",description:"Path to the file to read (e.g., 'folder/note.md')."},start_line:{type:"integer",description:"First line to read (1-indexed, inclusive). Defaults to 1."},end_line:{type:"integer",description:"Last line to read (1-indexed, inclusive). Defaults to last line."}},required:["path"]}};function ss(r,e){return r.map((t,n)=>`${e+n}: ${t}`).join(`
`)}function ln(r){return{definition:pr,execute:async e=>{let t=e.path,n=e.start_line,s=e.end_line;if(!t||typeof t!="string"||t.trim().length===0)return"Error: path is required and must be a non-empty string.";let o=t.trim();try{I(o)}catch(D){return D instanceof Error?`Error: ${D.message}`:"Error: Access denied."}let i=Rt(r,o);if(i.ambiguous)return`Error: Multiple files match "${o}" with different casing. Please specify the exact path.`;if(!i.item)return`Error: File not found: "${o}"`;let a=i.item,d=(await r.vault.read(a)).split(`
`),c=d.length,p=n!==void 0?Math.max(1,n):1,h=s!==void 0?Math.min(c,s):c;if(p>c)return`Error: start_line (${p}) exceeds total lines (${c}) in file.`;if(h<p)return`Error: end_line (${h}) must be greater than or equal to start_line (${p}).`;let u=d.slice(p-1,h),m=u.length,g=u,x=h,$=!1;if(m>cn&&(g=u.slice(0,cn),x=p+cn-1,$=!0),ss(g,p).length>ns){let D=0,H=0;for(let Ye of g){let se=`${p+H}: ${Ye}
`;if(D+se.length>ns)break;D+=se.length,H++}H===0&&(H=1),g=g.slice(0,H),x=p+H-1,$=!0}let C=ss(g,p);if($){let D=n!==void 0||s!==void 0?` of requested range ${p}-${h}`:"";return`${C}

[... truncated, showing lines ${p}-${x}${D}, total lines in file: ${c}]`}return n!==void 0||s!==void 0?`${C}

[Showing lines ${p}-${h} of ${c} total]`:C}}}var mr={name:"edit_file",description:"Edit a file using search/replace OR line-based operations. For search/replace: provide old_text and new_text. For line operations: provide insert_after_line, insert_before_line, or delete_lines. Operations are mutually exclusive.",inputSchema:{type:"object",properties:{path:{type:"string",description:"Path to the file to edit (e.g., 'folder/note.md')."},old_text:{type:"string",description:"The text to search for and replace (search/replace mode)."},new_text:{type:"string",description:"The text to replace old_text with (search/replace mode)."},replace_all:{type:"boolean",description:"If true, replace all occurrences of old_text. Defaults to false (replace first occurrence only)."},insert_after_line:{type:"integer",description:"Line number after which to insert content (1-indexed, or 0 to insert at the very beginning). Requires content parameter."},insert_before_line:{type:"integer",description:"Line number before which to insert content (1-indexed). Requires content parameter."},delete_lines:{type:"object",description:"Line range to delete (1-indexed, inclusive).",properties:{start:{type:"integer",description:"First line to delete (1-indexed)."},end:{type:"integer",description:"Last line to delete (1-indexed, inclusive)."}},required:["start","end"]},content:{type:"string",description:"Content to insert (required for insert_after_line and insert_before_line)."}},required:["path"]}};function hr(r,e){if(e.length===0)return 0;let t=0,n=0;for(;(n=r.indexOf(e,n))!==-1;)t++,n+=e.length;return t}function fr(r,e,t){let n=r.indexOf(e);return n===-1?r:r.slice(0,n)+t+r.slice(n+e.length)}function gr(r,e,t){if(e.length===0)return r;let n="",s=0,o=0;for(;(s=r.indexOf(e,o))!==-1;)n+=r.slice(o,s)+t,o=s+e.length;return n+=r.slice(o),n}function yr(r){let e=r.lastIndexOf("/");return e===-1?r:r.slice(e+1)}function vr(r){let e=r.old_text!==void 0||r.new_text!==void 0,t=r.insert_after_line!==void 0||r.insert_before_line!==void 0||r.delete_lines!==void 0;return e&&t?"conflict":e?"search_replace":t?"line_based":"none"}function un(r){return{definition:mr,execute:async e=>{let t=e.path;if(!t||typeof t!="string"||t.trim().length===0)return"Error: path is required and must be a non-empty string.";let n=t.trim(),s=yr(n),o=vr(e);if(o==="conflict")return"Error: Cannot mix search/replace parameters (old_text, new_text) with line-based parameters (insert_after_line, insert_before_line, delete_lines). Use one mode at a time.";if(o==="none")return"Error: Must provide either search/replace parameters (old_text, new_text) or line-based parameters (insert_after_line, insert_before_line, delete_lines).";try{I(n)}catch(a){return a instanceof Error?`Error: ${a.message}`:"Error: Access denied."}let i=r.vault.getFileByPath(n);return i?o==="search_replace"?wr(r,i,e,n,s):br(r,i,e,n):`Error: File not found: "${n}"`}}}async function wr(r,e,t,n,s){let o=t.old_text,i=t.new_text,a=t.replace_all;if(o==null||typeof o!="string")return"Error: old_text is required and must be a string.";if(o.length===0)return"Error: old_text cannot be empty.";if(i==null||typeof i!="string")return"Error: new_text is required and must be a string.";let l=0;return await r.vault.process(e,c=>{let p=hr(c,o);return p===0?(l=0,c):a?(l=p,gr(c,o,i)):(l=1,fr(c,o,i))}),l===0?`Error: Text '${o}' not found in ${s}`:`Replaced ${l} ${l===1?"occurrence":"occurrences"} in "${n}".`}async function br(r,e,t,n){let s=t.insert_after_line,o=t.insert_before_line,i=t.delete_lines,a=t.content;return[s,o,i].filter(d=>d!==void 0).length>1?"Error: Only one line-based operation can be specified at a time (insert_after_line, insert_before_line, or delete_lines).":s!==void 0?xr(r,e,s,a,n):o!==void 0?Mr(r,e,o,a,n):i!==void 0?Sr(r,e,i,n):"Error: No line-based operation specified."}async function xr(r,e,t,n,s){if(n==null||typeof n!="string")return"Error: content is required for insert operations.";if(!Number.isInteger(t)||t<0)return"Error: insert_after_line must be a non-negative integer.";let o=0,i=0,a=!1;return await r.vault.process(e,d=>{let c=d.split(`
`);if(o=c.length,t>o)return a=!1,d;let p=n.split(`
`);i=p.length;let h=[...c.slice(0,t),...p,...c.slice(t)];return a=!0,h.join(`
`)}),a?`Inserted ${i} ${i===1?"line":"lines"} after line ${t} in "${s}".`:`Error: Line ${t} does not exist in file with ${o} lines.`}async function Mr(r,e,t,n,s){if(n==null||typeof n!="string")return"Error: content is required for insert operations.";if(!Number.isInteger(t)||t<1)return"Error: insert_before_line must be a positive integer (1-indexed).";let o=0,i=0,a=!1;return await r.vault.process(e,d=>{let c=d.split(`
`);if(o=c.length,t>o)return a=!1,d;let p=n.split(`
`);i=p.length;let h=t-1,u=[...c.slice(0,h),...p,...c.slice(h)];return a=!0,u.join(`
`)}),a?`Inserted ${i} ${i===1?"line":"lines"} before line ${t} in "${s}".`:`Error: Line ${t} does not exist in file with ${o} lines.`}async function Sr(r,e,t,n){let{start:s,end:o}=t;if(!Number.isInteger(s)||s<1)return"Error: delete_lines.start must be a positive integer (1-indexed).";if(!Number.isInteger(o)||o<1)return"Error: delete_lines.end must be a positive integer (1-indexed).";if(o<s)return"Error: delete_lines.end must be >= delete_lines.start.";let i=0,a=0,l=!1,d=null;return await r.vault.process(e,c=>{let p=c.split(`
`);if(i=p.length,s>i)return l=!1,d="start",c;if(o>i)return l=!1,d="end",c;let h=s-1,u=o;a=o-s+1;let m=[...p.slice(0,h),...p.slice(u)];return l=!0,m.join(`
`)}),l?`Deleted lines ${s}-${o} (${a} ${a===1?"line":"lines"}) in "${n}".`:d==="start"?`Error: Line ${s} does not exist in file with ${i} lines.`:d==="end"?`Error: Line ${o} does not exist in file with ${i} lines.`:"Error: Invalid line range."}var Cr={name:"write_file",description:"Write content to a file, creating it if it doesn't exist or overwriting if it does. Parent directories are created automatically.",inputSchema:{type:"object",properties:{path:{type:"string",description:"Path to the file to write (e.g., 'folder/file.md')."},content:{type:"string",description:"Content to write to the file."}},required:["path","content"]}};function Er(r){return r<1024?`${r} bytes`:`${(r/1024).toFixed(1)} KB`}async function _r(r,e){let t=e.lastIndexOf("/");if(t<=0)return;let n=e.substring(0,t);r.vault.getFolderByPath(n)||await r.vault.createFolder(n)}function dn(r){return{definition:Cr,execute:async e=>{let t=e.path,n=e.content;if(!t||typeof t!="string"||t.trim().length===0)return"Error: path is required and must be a non-empty string.";if(n==null||typeof n!="string")return"Error: content is required and must be a string.";let s=t.trim();try{I(s)}catch(d){return d instanceof Error?`Error: ${d.message}`:"Error: Access denied."}let o=r.vault.getFileByPath(s);try{o?await r.vault.modify(o,n):(await _r(r,s),await r.vault.create(s,n))}catch(d){let c=d instanceof Error?d.message:"Unknown error occurred";return`Error: Failed to write file "${s}": ${c}`}let i=new TextEncoder().encode(n).length,a=Er(i);return`${o?"Overwrote":"Created"} file "${s}" (${a}).`}}}var Rr={name:"create_folder",description:"Create a folder in the vault. Parent directories are created automatically if they don't exist.",inputSchema:{type:"object",properties:{path:{type:"string",description:"Path to the folder to create (e.g., 'folder/subfolder')."}},required:["path"]}};function Pr(r){let e=r.trim();return e=e.replace(/^\/+/,""),e=e.replace(/\/+$/,""),e}function pn(r){return{definition:Rr,execute:async e=>{let t=e.path;if(!t||typeof t!="string")return"Error: path is required and must be a string.";let n=Pr(t);if(n.length===0)return"Error: path cannot be empty or root.";try{I(n)}catch(o){return o instanceof Error?`Error: ${o.message}`:"Error: Access denied."}if(r.vault.getFolderByPath(n))return`Folder "${n}" already exists.`;try{await r.vault.createFolder(n)}catch(o){let i=o instanceof Error?o.message:"Unknown error occurred";return`Error: Failed to create folder "${n}": ${i}`}return`Created folder "${n}".`}}}var Tr={name:"delete_file",description:"Soft-delete a file or folder to Obsidian's trash. Respects user's trash settings.",inputSchema:{type:"object",properties:{path:{type:"string",description:"Path to the file or folder to delete (e.g., 'folder/note.md' or 'folder')."}},required:["path"]}};function mn(r){return{definition:Tr,execute:async e=>{var a;let t=e.path;if(!t||typeof t!="string"||t.trim().length===0)return"Error: path is required and must be a non-empty string.";let n=t.trim();try{I(n)}catch(l){return l instanceof Error?`Error: ${l.message}`:"Error: Access denied."}let s=r.vault.getAbstractFileByPath(n);if(!s)return`Error: File or folder not found: "${n}"`;let i=((a=r.vault.config)==null?void 0:a.trashOption)==="system";try{await r.vault.trash(s,i)}catch(l){let d=l instanceof Error?l.message:"Unknown error occurred";return`Error: Failed to delete "${n}": ${d}`}return`Deleted '${n}' to trash.`}}}var Ar={name:"move_file",description:"Move or rename a file or folder. Moves to a new location or renames in place. Parent directories are created automatically if needed.",inputSchema:{type:"object",properties:{source:{type:"string",description:"Path to the file or folder to move (e.g., 'old-folder/note.md')."},destination:{type:"string",description:"New path for the file or folder (e.g., 'new-folder/renamed-note.md')."}},required:["source","destination"]}};function rs(r){let e=r.replace(/\\/g,"/");return e=e.replace(/\/+$/,""),e=e.replace(/^\/+/,""),e}async function kr(r,e){let t=e.lastIndexOf("/");if(t<=0)return;let n=e.substring(0,t);r.vault.getFolderByPath(n)||await r.vault.createFolder(n)}function hn(r){return{definition:Ar,execute:async e=>{let t=e.source,n=e.destination;if(!t||typeof t!="string"||t.trim().length===0)return"Error: source is required and must be a non-empty string.";if(!n||typeof n!="string"||n.trim().length===0)return"Error: destination is required and must be a non-empty string.";let s=rs(t.trim()),o=rs(n.trim());if(s===o)return`No changes made: source and destination are the same path ("${s}").`;try{I(s)}catch(l){return l instanceof Error?`Error: ${l.message}`:"Error: Access denied."}try{I(o)}catch(l){return l instanceof Error?`Error: ${l.message}`:"Error: Access denied."}let i=r.vault.getAbstractFileByPath(s);if(!i)return`Error: Source not found: "${s}"`;if(r.vault.getAbstractFileByPath(o))return`Error: Destination already exists: "${o}"`;try{await kr(r,o),await r.fileManager.renameFile(i,o)}catch(l){let d=l instanceof Error?l.message:"Unknown error occurred";return`Error: Failed to move "${s}" to "${o}": ${d}`}return`Moved "${s}" to "${o}".`}}}var Ir=2,Lr=10,$r=5;function Fr(r,e){let t=r.split(`
`),n=[];for(let s=0;s<t.length;s++)e.lastIndex=0,e.test(t[s])&&n.push(s);return n}function Dr(r,e,t){let n=r.split(`
`),s=[],o=new Set;for(let i of e){if(o.has(i))continue;if(s.length>=$r)break;let a=Math.max(0,i-t),l=Math.min(n.length-1,i+t),d=[];for(let p=a;p<i;p++)d.push(n[p]);let c=[];for(let p=i+1;p<=l;p++)c.push(n[p]);s.push({lineNumber:i+1,beforeLines:d,matchLine:n[i],afterLines:c});for(let p=a;p<=l;p++)o.add(p)}return s}function Hr(r){let e=[],t=r.lineNumber-r.beforeLines.length;for(let n=0;n<r.beforeLines.length;n++)e.push(`Line ${t+n}:   ${r.beforeLines[n]}`);e.push(`Line ${r.lineNumber}: > ${r.matchLine}`);for(let n=0;n<r.afterLines.length;n++)e.push(`Line ${r.lineNumber+1+n}:   ${r.afterLines[n]}`);return e.join(`
`)}function Nr(r){if(r.length===0)return"No files found matching the pattern.";let e=[`Found ${r.length} matching file(s):
`];for(let t of r){e.push(`## ${t.path}`);for(let n of t.excerpts)e.push(Hr(n)),e.push("")}return e.join(`
`).trim()}async function Or(r,e,t,n){if(ze(r.path))return null;let s=await n.vault.cachedRead(r),o=Fr(s,e);if(o.length===0)return null;let i=Dr(s,o,t);return{path:r.path,excerpts:i}}var Br={name:"search_files",description:"Search file contents using regex patterns. Returns matching file paths with excerpts showing context around matches. Note: Patterns are matched against individual lines, so multi-line patterns that span line breaks will not match.",inputSchema:{type:"object",properties:{pattern:{type:"string",description:"Regex pattern to search for in file contents."},file_pattern:{type:"string",description:"Glob pattern to filter files (e.g., '*.md', 'Projects/**', '**/*.txt'). When provided, searches all matching files. When omitted, searches only markdown files."},context_lines:{type:"integer",description:"Number of lines to show before and after each match. Default is 2."},max_results:{type:"integer",description:"Maximum number of files to return. Default is 10."}},required:["pattern"]}};function fn(r){return{definition:Br,execute:async e=>{let t=e.pattern,n=e.file_pattern,s=e.context_lines,o=e.max_results;if(!t||typeof t!="string"||t.trim().length===0)return"Error: pattern is required and must be a non-empty string.";let i=t.trim(),a;try{a=new RegExp(i,"g")}catch(h){let u=h instanceof Error?h.message:"Unknown error";return`Error: Invalid regex pattern "${i}": ${u}`}let l=s!==void 0&&s>=0?s:Ir,d=o!==void 0&&o>0?o:Lr,c;if(n&&typeof n=="string"&&n.trim().length>0){let h=n.trim();c=r.vault.getFiles().filter(u=>_t(u.path,h))}else c=r.vault.getMarkdownFiles();let p=[];for(let h of c){let u=await Or(h,a,l,r);if(u&&(p.push(u),p.length>=d))break}return Nr(p)}}}function L(r){if(!r)return r;let e=new Date(r);return isNaN(e.getTime())?r:e.toLocaleString(void 0,{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"})}function pe(r){return L(new Date(r).toISOString())}function os(r){let e=new Date(r);return isNaN(e.getTime())?String(r):e.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"})}var Ur="*",is=100,as=1e3;function jr(r,e){let t=Y(e),n=Y(r);return t.length===0?n:n==="*"?`${t}/*`:n==="**"?`${t}/**`:`${t}/${n}`}function qr(r,e,t){if(r.length===0){let s=t?`"${t}"`:"vault root";return`No files or folders match the pattern "${e}" in ${s}.`}let n=[`Found ${r.length} item(s):
`];for(let s of r)s.type==="folder"?n.push(`[folder] ${s.path}/`):n.push(`[file] ${s.path} (modified: ${os(s.mtime)})`);return n.join(`
`)}var Wr={name:"list_files",description:"List files and folders matching a glob pattern. Returns paths sorted by modification time (most recent first).",inputSchema:{type:"object",properties:{pattern:{type:"string",description:"Glob pattern to match (e.g., '*.md', '**/*.md', 'Projects/**'). Default: '*' for current directory."},path:{type:"string",description:"Base path to search from. Default: vault root."},max_results:{type:"integer",description:`Maximum number of items to return (1-${as}). Default: ${is}.`}},required:[]}};function gn(r){return{definition:Wr,execute:async e=>{var h;let t=e.pattern,n=e.path,s=e.max_results,o=(t==null?void 0:t.trim())||Ur,i=n?Y(n):"",a=is;if(s!==void 0){if(typeof s!="number"||!Number.isInteger(s))return"Error: max_results must be an integer.";if(s<1)return"Error: max_results must be at least 1.";a=Math.min(s,as)}if(i.length>0){let u=Pt(r,i);if(u.ambiguous)return`Error: Multiple folders match "${i}" with different casing. Please specify the exact path.`;if(!u.item)return`Error: Path "${i}" does not exist or is not a folder.`}let l=jr(o,i),d=r.vault.getAllLoadedFiles(),c=[];for(let u of d){if(ze(u.path)||u.path===""||u.path==="/"||!_t(u.path,l))continue;let m=!u.extension,g=0;if(!m)g=u.stat.mtime;else try{let x=await r.vault.adapter.stat(u.path);g=(h=x==null?void 0:x.mtime)!=null?h:0}catch(x){g=0}c.push({path:u.path,type:m?"folder":"file",mtime:g})}c.sort((u,m)=>u.mtime===m.mtime?u.path.localeCompare(m.path):m.mtime-u.mtime);let p=c.slice(0,a);return qr(p,o,i)}}}var zr={name:"get_file_info",description:"Get metadata about a file or folder including creation date, modification date, and size.",inputSchema:{type:"object",properties:{path:{type:"string",description:"Path to the file or folder (e.g., 'folder/note.md' or 'folder')."}},required:["path"]}};function Vr(r){let e=r.toLocaleString();return r<1024?`${r} bytes`:r<1024*1024?`${(r/1024).toFixed(1)} KB (${e} bytes)`:`${(r/(1024*1024)).toFixed(1)} MB (${e} bytes)`}function yn(r){return{definition:zr,execute:async e=>{let t=e.path;if(!t||typeof t!="string"||t.trim().length===0)return"Error: path is required and must be a non-empty string.";let n=t.trim();try{I(n)}catch(i){return i instanceof Error?`Error: ${i.message}`:"Error: Access denied."}let s=Rt(r,n);if(s.ambiguous)return`Error: Multiple files match "${n}" with different casing. Please specify the exact path.`;if(s.item){let i=s.item.path,a=await r.vault.adapter.stat(i);return a?[`File: ${i}`,"Type: file",`Size: ${Vr(a.size)}`,`Created: ${pe(a.ctime)}`,`Modified: ${pe(a.mtime)}`].join(`
`):`Error: Unable to read file metadata: "${i}"`}let o=Pt(r,n);if(o.ambiguous)return`Error: Multiple folders match "${n}" with different casing. Please specify the exact path.`;if(o.item){let i=o.item.path,a=await r.vault.adapter.stat(i);return a?[`Folder: ${i}/`,"Type: folder",`Created: ${pe(a.ctime)}`,`Modified: ${pe(a.mtime)}`].join(`
`):`Error: Unable to read folder metadata: "${i}"`}return`Error: Path not found: "${n}"`}}}var Gr={name:"get_active_note",description:"Get the path and metadata of the file currently open in the editor. Returns the file path, name, and modification date. Use this when the user refers to 'this note', 'the current file', or wants to operate on what they're looking at.",inputSchema:{type:"object",properties:{},required:[]}};function vn(r){return{definition:Gr,execute:async()=>{let e=r.workspace.getActiveFile();if(!e)return"No file is currently open. The user may be viewing settings, an empty workspace, or a non-file view.";let t=e.stat;return[`Active file: ${e.path}`,`Name: ${e.name}`,`Modified: ${pe(t.mtime)}`].join(`
`)}}}var Xr={name:"send_message",description:"Send a message to the user. Use this to provide updates, ask questions, or communicate progress during task execution. Messages are delivered immediately in real-time.",inputSchema:{type:"object",properties:{message:{type:"string",description:"The message to send to the user."},is_question:{type:"boolean",description:"Set to true if this message is asking for user input. This signals that you are waiting for a response before continuing."}},required:["message"]}};function Tt(r){return{definition:Xr,execute:async e=>{var s;let t=e.message,n=(s=e.is_question)!=null?s:!1;if(!t||typeof t!="string"||t.trim().length===0)return"Error: message is required and must be a non-empty string.";if(r.sendToChatView(t,n),r.source==="websocket"){let o=n?"high":"normal";r.sendToSmartHole(t,o)}return n&&r.setWaitingForResponse&&r.setWaitingForResponse(t),n?"Message sent. Waiting for user response.":"Message sent successfully."}}}var Kr={name:"end_conversation",description:"End the current conversation and generate a summary. Use this when a topic is concluded, the user indicates they're done, or when moving to an unrelated topic. A new conversation will start with the next message.",inputSchema:{type:"object",properties:{reason:{type:"string",description:"Optional reason for ending the conversation (e.g., 'task completed', 'user requested', 'changing topics')"}},required:[]}};function At(r){return{definition:Kr,execute:async e=>{let t=e.reason;if(!r.conversationManager.getActiveConversation())return"No active conversation to end.";try{let s=r.getLLMService();return await r.conversationManager.endConversation(s),`Conversation ended successfully.${t?` Reason: ${t}`:""} A summary has been generated. The next message will start a new conversation.`}catch(s){return`Failed to end conversation: ${s instanceof Error?s.message:"Unknown error"}`}}}}var Jr={name:"get_conversation",description:"Retrieve past conversation details. Use with conversation_id to get a specific conversation's full history, or use list_recent to get summaries of recent conversations. Only completed conversations are accessible (not the current active one).",inputSchema:{type:"object",properties:{conversation_id:{type:"string",description:"The ID of a specific conversation to retrieve. Returns full conversation history with all messages."},list_recent:{type:"number",description:"Number of recent conversations to list (summaries only, no full message content). Defaults to 10."}},required:[]}};function kt(r){return{definition:Jr,execute:async e=>{let t=e.conversation_id,n=e.list_recent;if(t!==void 0){if(typeof t!="string"||t.trim().length===0)return JSON.stringify({error:"conversation_id must be a non-empty string"});let a=r.conversationManager.getConversation(t);if(!a)return JSON.stringify({error:`Conversation not found: ${t}`});if(a.endedAt===null)return JSON.stringify({error:"Cannot retrieve active conversation. Only completed conversations are accessible."});let l={id:a.id,title:a.title,summary:a.summary,startedAt:L(a.startedAt),endedAt:a.endedAt?L(a.endedAt):null,messages:a.messages.map(d=>({timestamp:L(d.timestamp),role:d.role,content:d.content,...d.toolsUsed&&d.toolsUsed.length>0?{toolsUsed:d.toolsUsed}:{}}))};return JSON.stringify(l)}let s=10;n!==void 0&&typeof n=="number"&&n>0&&(s=Math.floor(n));let i={conversations:r.conversationManager.getRecentConversations(s).map(a=>({id:a.id,title:a.title,summary:a.summary,startedAt:L(a.startedAt),endedAt:a.endedAt?L(a.endedAt):null,messageCount:a.messages.length}))};return JSON.stringify(i)}}}function wn(r){return[ln(r),un(r),dn(r),pn(r),mn(r),hn(r),fn(r),gn(r),yn(r),vn(r)]}var It="conversationData",bn="conversationHistory",Yr=2,Ve=class{constructor(e){this.plugin=e,this.conversations=[],this.activeConversationId=null}async load(){let e=await this.plugin.loadData();if(e&&e[It]){this.loadFromPersistedConversations(e[It]);return}if(e&&e[bn]){let t=this.validateOldHistory(e[bn]);await this.migrateFromOldFormat(t);return}this.conversations=[],this.activeConversationId=null}async save(){let e=await this.plugin.loadData()||{},t={conversations:this.conversations};e[It]=t,await this.plugin.saveData(e)}getActiveConversation(){var e;return this.activeConversationId&&(e=this.conversations.find(t=>t.id===this.activeConversationId))!=null?e:null}async addMessage(e,t){if(this.shouldStartNewConversation()){if(this.activeConversationId&&t)await this.endConversation(t);else if(this.activeConversationId){let o=this.getActiveConversation();o&&(o.endedAt=new Date().toISOString(),this.activeConversationId=null)}let s=this.createConversation();this.conversations.push(s),this.activeConversationId=s.id,this.enforceConversationLimit()}let n=this.getActiveConversation();if(!n)throw new Error("No active conversation available");return n.messages.push(e),await this.save(),n}async endConversation(e){let t=this.getActiveConversation();if(t){if(t.endedAt=new Date().toISOString(),e&&t.messages.length>0)try{let{title:n,summary:s}=await this.generateConversationSummary(t.id,e);t.title=n,t.summary=s}catch(n){console.error("Failed to generate conversation summary:",n),t.title="Conversation",t.summary="Summary generation failed."}this.activeConversationId=null,this.enforceConversationLimit(),await this.save()}}async clearAll(){this.conversations=[],this.activeConversationId=null,await this.save()}async forkConversation(e){let t=this.getActiveConversation();if(!t)throw new Error("No active conversation to fork");let n=t.messages.findIndex(i=>i.id===e);if(n===-1)throw new Error(`Message not found in active conversation: ${e}`);let s=t.messages.slice(n),o={messages:s,archivedAt:new Date().toISOString()};return t.archivedBranches||(t.archivedBranches=[]),t.archivedBranches.push(o),t.messages=t.messages.slice(0,n),await this.save(),{archivedMessages:s,forkPoint:n}}async generateConversationSummary(e,t){var c,p;let n=this.getConversation(e);if(!n)throw new Error(`Conversation not found: ${e}`);let o=`Analyze this conversation between a user and an Obsidian vault assistant.

Conversation:
${n.messages.map(h=>{var m;let u=(m=h.toolsUsed)!=null&&m.length?` (tools: ${h.toolsUsed.join(", ")})`:"";return`[${L(h.timestamp)}]
${h.role==="user"?"User":"Assistant"}: ${h.content}${u}`}).join(`

---

`)}

Generate:
1. A brief title (5-8 words max) that captures the main topic
2. A concise summary (2-3 sentences) covering: topics discussed, actions taken, and outcomes

Format your response as:
TITLE: [your title here]
SUMMARY: [your summary here]`,i=await t.processMessage(o),a=K(i),l=a.match(/TITLE:\s*(.+?)(?:\n|$)/i),d=a.match(/SUMMARY:\s*(.+)/is);return{title:((c=l==null?void 0:l[1])==null?void 0:c.trim())||"Untitled Conversation",summary:((p=d==null?void 0:d[1])==null?void 0:p.trim())||"No summary available."}}shouldStartNewConversation(){if(!this.activeConversationId)return!0;let e=this.getActiveConversation();if(!e||e.messages.length===0)return!0;let t=e.messages[e.messages.length-1],n=new Date(t.timestamp).getTime(),s=Date.now(),o=this.getIdleTimeoutMs();return s-n>o}getIdleTimeoutMs(){var t;return((t=this.plugin.settings.conversationIdleTimeoutMinutes)!=null?t:30)*60*1e3}enforceConversationLimit(){var n;let e=(n=this.plugin.settings.maxConversationsRetained)!=null?n:1e3,t=this.conversations.filter(s=>s.endedAt!==null);if(t.length>e){let o=[...t].sort((a,l)=>new Date(a.endedAt).getTime()-new Date(l.endedAt).getTime()).slice(0,t.length-e),i=new Set(o.map(a=>a.id));this.conversations=this.conversations.filter(a=>!i.has(a.id))}}getContextPrompt(){let e=[],t=this.getRecentConversations(Yr).filter(s=>s.title!==null&&s.summary!==null);if(t.length>0){let s=t.map(o=>`### ${o.title} (ended ${L(o.endedAt)})
${o.summary}`).join(`

`);e.push(`## Recent Conversations
${s}`)}let n=this.getActiveConversation();if(n&&n.messages.length>0){let s=n.messages.map(o=>{var a;let i=(a=o.toolsUsed)!=null&&a.length?` [used: ${o.toolsUsed.join(", ")}]`:"";return`[${L(o.timestamp)}]
${o.role==="user"?"User":"Assistant"}: ${o.content}${i}`}).join(`

`);e.push(`## Current Conversation
${s}`)}return e.join(`

`)}getConversation(e){var t;return(t=this.conversations.find(n=>n.id===e))!=null?t:null}getRecentConversations(e=10){return this.conversations.filter(t=>t.endedAt!==null).sort((t,n)=>new Date(n.endedAt).getTime()-new Date(t.endedAt).getTime()).slice(0,e)}createConversation(){let e=new Date().toISOString();return{id:`conv-${Date.now()}`,startedAt:e,endedAt:null,title:null,summary:null,messages:[]}}async migrateFromOldFormat(e){var a;console.log("ConversationManager: Migrating from old conversation history format");let t=e.recentConversations||[],n=e.summaries||[];if(t.length===0&&n.length===0){this.conversations=[],this.activeConversationId=null,await this.save();return}let s={id:`conv-migrated-${Date.now()}`,startedAt:((a=t[0])==null?void 0:a.timestamp)||new Date().toISOString(),endedAt:new Date().toISOString(),title:"Migrated Conversation History",summary:this.buildMigrationSummary(t,n),messages:this.convertOldEntriesToMessages(t)};this.conversations=[s],this.activeConversationId=null;let o=await this.plugin.loadData()||{};delete o[bn];let i=this.toPersistedFormat();i.lastMigrated=new Date().toISOString(),o[It]=i,await this.plugin.saveData(o),console.log(`ConversationManager: Migrated ${t.length} entries to new format`)}convertOldEntriesToMessages(e){let t=[];for(let n of e){t.push({id:`${n.id}-user`,timestamp:n.timestamp,role:"user",content:n.userMessage});let s=n.toolsUsed||[];t.push({id:`${n.id}-assistant`,timestamp:n.timestamp,role:"assistant",content:n.assistantResponse,toolsUsed:s.length>0?s:void 0})}return t}buildMigrationSummary(e,t){let n=[];if(t.length>0){n.push("Historical summaries:");for(let s of t)n.push(`- ${s.startDate} to ${s.endDate} (${s.conversationCount} conversations): ${s.summary}`)}if(e.length>0){n.push(`
Migrated ${e.length} recent conversations from previous format.`);let s=new Set;for(let o of e){let i=o.toolsUsed||[];for(let a of i)s.add(a)}s.size>0&&n.push(`Tools used: ${Array.from(s).join(", ")}`)}return n.join(`
`)||"Migrated from legacy conversation history format."}toPersistedFormat(){return{conversations:this.conversations}}validateOldHistory(e){if(!e||typeof e!="object")return{recentConversations:[],summaries:[],lastSummarized:""};let t=e;return{recentConversations:Array.isArray(t.recentConversations)?t.recentConversations.filter(this.isValidHistoryEntry):[],summaries:Array.isArray(t.summaries)?t.summaries.filter(this.isValidSummary):[],lastSummarized:typeof t.lastSummarized=="string"?t.lastSummarized:""}}isValidHistoryEntry(e){if(!e||typeof e!="object")return!1;let t=e;return typeof t.id=="string"&&typeof t.timestamp=="string"&&typeof t.userMessage=="string"&&typeof t.assistantResponse=="string"&&Array.isArray(t.toolsUsed)}isValidSummary(e){if(!e||typeof e!="object")return!1;let t=e;return typeof t.startDate=="string"&&typeof t.endDate=="string"&&typeof t.summary=="string"&&typeof t.conversationCount=="number"}loadFromPersistedConversations(e){var s;let t=this.validatePersistedData(e);this.conversations=t.conversations;let n=this.conversations.find(o=>o.endedAt===null);this.activeConversationId=(s=n==null?void 0:n.id)!=null?s:null}validatePersistedData(e){if(!e||typeof e!="object")return{conversations:[]};let t=e;return{conversations:Array.isArray(t.conversations)?t.conversations.filter(this.isValidConversation):[],lastMigrated:typeof t.lastMigrated=="string"?t.lastMigrated:void 0}}isValidConversation(e){if(!e||typeof e!="object")return!1;let t=e;return typeof t.id=="string"&&typeof t.startedAt=="string"&&(t.endedAt===null||typeof t.endedAt=="string")&&(t.title===null||typeof t.title=="string")&&(t.summary===null||typeof t.summary=="string")&&Array.isArray(t.messages)}};var Lt=".smarthole/inbox",Ge=class{constructor(e){this.vault=e}async save(e){await this.ensureInboxFolder();let{id:t,text:n,timestamp:s,metadata:o}=e.payload,i=new Date().toISOString(),a=this.generateFilename(s,t),l=`${Lt}/${a}`,d=this.formatMessageContent(t,s,i,o,n);return await this.vault.create(l,d),l}async delete(e){let t=await this.findFileByMessageId(e);t&&await this.vault.delete(t)}async listPending(){let e=this.getInboxFiles(),t=[];for(let n of e){let s=await this.parseInboxFile(n);s&&t.push(s)}return t.sort((n,s)=>new Date(n.timestamp).getTime()-new Date(s.timestamp).getTime()),t}async get(e){let t=await this.findFileByMessageId(e);return t?this.parseInboxFile(t):null}async ensureInboxFolder(){let e=".smarthole";if(!this.vault.getFolderByPath(e))try{await this.vault.createFolder(e)}catch(s){if(!(s instanceof Error&&s.message.includes("Folder already exists")))throw s}if(!this.vault.getFolderByPath(Lt))try{await this.vault.createFolder(Lt)}catch(s){if(!(s instanceof Error&&s.message.includes("Folder already exists")))throw s}}generateFilename(e,t){return`${e.replace(/:/g,"-")}-${t}.md`}formatMessageContent(e,t,n,s,o){let i=JSON.stringify(s);return`---
id: ${e}
timestamp: ${t}
receivedAt: ${n}
metadata: ${i}
---

${o}
`}getInboxFiles(){return this.vault.getFiles().filter(t=>t.path.startsWith(`${Lt}/`)&&t.extension==="md")}async findFileByMessageId(e){let t=this.getInboxFiles(),n=`-${e}.md`;for(let s of t)if(s.name.endsWith(n))return s;return null}async parseInboxFile(e){try{let t=await this.vault.read(e);return this.parseMessageContent(t,e.path)}catch(t){return null}}parseMessageContent(e,t){let n=e.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);if(!n)return null;let s=n[1],o=n[2].trim(),i=s.match(/^id:\s*(.+)$/m),a=s.match(/^timestamp:\s*(.+)$/m),l=s.match(/^receivedAt:\s*(.+)$/m),d=s.match(/^metadata:\s*(.+)$/m);if(!i||!a||!l||!d)return null;let c;try{c=JSON.parse(d[1])}catch(p){return null}return{id:i[1],timestamp:a[1],receivedAt:l[1],metadata:c,text:o,filePath:t}}};var cs=".smarthole/retrospection.md",Xe=class{constructor(e,t){this.app=e,this.settings=t}async runRetrospection(e){let t=this.buildPrompt(e),n=new J(this.app,this.settings);await n.initialize();let s=await n.processMessage(t),o=K(s),i=new Date().toISOString(),a=e.title||"Untitled";return await this.persistRetrospection(a,o,i),{conversationTitle:a,content:o,timestamp:i}}buildPrompt(e){let t=e.title||"Untitled",n=e.messages.map(s=>{var i;let o=(i=s.toolsUsed)!=null&&i.length?` (tools: ${s.toolsUsed.join(", ")})`:"";return`[${L(s.timestamp)}] ${s.role==="user"?"User":"Assistant"}: ${s.content}${o}`}).join(`

`);return`Here is a completed conversation titled "${t}":

${n}

---

${this.settings.retrospectionPrompt}`}formatEntry(e,t,n){return`## ${e} \u2014 ${L(n)}

${t}

---

`}async persistRetrospection(e,t,n){let s=this.formatEntry(e,t,n),o=this.app.vault.adapter,i="";try{i=await o.read(cs)}catch(l){}let a=s+i;await o.write(cs,a)}};var xn=3,Qr=1e3,Mn="conversationStates",Ke=class{constructor(e){this.responseCallbacks=[];this.messageReceivedCallbacks=[];this.agentMessageCallbacks=[];this.retrospectionCallbacks=[];this.currentLLMService=null;this.conversationStates=new Map;this.connection=e.connection,this.inboxManager=e.inboxManager,this.app=e.app,this.settings=e.settings,this.conversationManager=e.conversationManager,this.plugin=e.plugin}async initialize(){await this.loadConversationStates(),await this.cleanupStaleStates()}cancelCurrentProcessing(){var e;(e=this.currentLLMService)==null||e.abort(),this.currentLLMService=null}onResponse(e){return this.responseCallbacks.push(e),()=>{let t=this.responseCallbacks.indexOf(e);t>=0&&this.responseCallbacks.splice(t,1)}}onMessageReceived(e){return this.messageReceivedCallbacks.push(e),()=>{let t=this.messageReceivedCallbacks.indexOf(e);t>=0&&this.messageReceivedCallbacks.splice(t,1)}}onAgentMessage(e){return this.agentMessageCallbacks.push(e),()=>{let t=this.agentMessageCallbacks.indexOf(e);t>=0&&this.agentMessageCallbacks.splice(t,1)}}onRetrospection(e){return this.retrospectionCallbacks.push(e),()=>{let t=this.retrospectionCallbacks.indexOf(e);t>=0&&this.retrospectionCallbacks.splice(t,1)}}notifyAgentMessageCallbacks(e,t){let n={content:e,isQuestion:t,timestamp:new Date().toISOString()};for(let s of this.agentMessageCallbacks)try{s(n)}catch(o){console.error("MessageProcessor: Agent message callback error:",o)}}notifyMessageReceivedCallbacks(e){for(let t of this.messageReceivedCallbacks)try{t(e)}catch(n){console.error("MessageProcessor: Message received callback error:",n)}}notifyResponseCallbacks(e){for(let t of this.responseCallbacks)try{t(e)}catch(n){console.error("MessageProcessor: Response callback error:",n)}}notifyRetrospection(e){for(let t of this.retrospectionCallbacks)try{t(e)}catch(n){console.error("MessageProcessor: Retrospection callback error:",n)}}async runRetrospection(e){let n=await new Xe(this.app,this.settings).runRetrospection(e);this.notifyRetrospection(n)}async process(e,t=!1){var i,a,l;let n=e.payload.id;this.notifyMessageReceivedCallbacks(e);try{await this.inboxManager.save(e)}catch(d){let c=d instanceof Error?d.message:"Failed to save message to inbox";return console.error(`MessageProcessor: Failed to save message ${n} to inbox:`,d),{success:!1,messageId:n,error:c}}t||this.connection.sendAck(n);let s=((i=e.payload.metadata)==null?void 0:i.source)==="direct"?"direct":"websocket",o=await this.processWithRetry(e.payload.text,n,s);if(o.success){((a=e.payload.metadata)==null?void 0:a.source)!=="direct"&&this.sendSuccessNotification(n,o.response),this.notifyResponseCallbacks({messageId:n,success:!0,response:o.response,originalMessage:e.payload.text,toolsUsed:o.toolsUsed});try{await this.inboxManager.delete(n)}catch(d){console.error(`MessageProcessor: Failed to delete message ${n} from inbox:`,d)}return{success:!0,messageId:n,response:o.response,isWaitingForResponse:o.isWaitingForResponse}}else return((l=e.payload.metadata)==null?void 0:l.source)!=="direct"&&this.sendErrorNotification(n,o.error),this.notifyResponseCallbacks({messageId:n,success:!1,error:o.error,originalMessage:e.payload.text,toolsUsed:[]}),{success:!1,messageId:n,error:o.error}}async reprocessPending(){let e;try{e=await this.inboxManager.listPending()}catch(t){console.error("MessageProcessor: Failed to list pending messages:",t);return}if(e.length===0){console.log("MessageProcessor: No pending messages to reprocess");return}console.log(`MessageProcessor: Reprocessing ${e.length} pending message(s)`);for(let t of e){let n={type:"message",payload:{id:t.id,text:t.text,timestamp:t.timestamp,metadata:t.metadata}},s=await this.process(n,!0);s.success?console.log(`MessageProcessor: Successfully reprocessed message ${t.id}`):console.error(`MessageProcessor: Failed to reprocess message ${t.id}: ${s.error}`)}}async processWithRetry(e,t,n){var o,i,a,l;let s;for(let d=1;d<=xn;d++)try{let c=new J(this.app,this.settings);await c.initialize(),this.currentLLMService=c;try{let p=this.conversationManager.getActiveConversation(),h=this.conversationManager.getContextPrompt();if(p){let S=this.conversationStates.get(p.id);if(S!=null&&S.isWaitingForResponse){c.restoreConversationState({isWaitingForResponse:!1,pendingContext:S.pendingContext});let k=this.buildContinuationContext(S);h=h+`

`+k,this.conversationStates.delete(p.id),await this.persistConversationStates()}}c.setConversationContext(h);let u=wn(this.app),m=u.map(S=>S.definition.name);for(let S of u)c.registerTool(S);let x=Tt({sendToSmartHole:(S,k="normal")=>{this.connection.sendNotification(t,{body:S,priority:k})},sendToChatView:(S,k)=>{this.notifyAgentMessageCallbacks(S,k)},source:n,setWaitingForResponse:S=>{c.setWaitingForResponse(S,t)}});c.registerTool(x),m.push(x.definition.name);let $={conversationManager:this.conversationManager,getLLMService:()=>c},A=At($);c.registerTool(A),m.push(A.definition.name);let C={conversationManager:this.conversationManager},D=kt(C);c.registerTool(D),m.push(D.definition.name);let H=await c.processMessage(e),Ye=K(H),se=this.extractToolsUsed(c,m),Nt=(i=(o=this.conversationManager.getActiveConversation())==null?void 0:o.id)!=null?i:null,En=new Date().toISOString(),gs={id:`${t}-user`,timestamp:En,role:"user",content:e};if(await this.conversationManager.addMessage(gs,c),this.settings.enableConversationRetrospection&&Nt!==null&&((l=(a=this.conversationManager.getActiveConversation())==null?void 0:a.id)!=null?l:null)!==Nt){let k=this.conversationManager.getConversation(Nt);k&&this.runRetrospection(k).catch(Ot=>console.error("MessageProcessor: Retrospection failed:",Ot))}let ys={id:`${t}-assistant`,timestamp:En,role:"assistant",content:Ye,toolsUsed:se.length>0?se:void 0};if(await this.conversationManager.addMessage(ys),this.settings.enableConversationRetrospection&&se.includes("end_conversation")){let k=this.conversationManager.getRecentConversations(1)[0];k&&this.runRetrospection(k).catch(Ot=>console.error("MessageProcessor: Retrospection failed:",Ot))}let _n=c.isWaitingForUserResponse();if(_n){let S=c.getConversationState(),k=this.conversationManager.getActiveConversation();k&&S.isWaitingForResponse&&(this.conversationStates.set(k.id,S),await this.persistConversationStates(),console.log(`MessageProcessor: Persisted waiting state for conversation ${k.id}`))}return{success:!0,response:Ye,toolsUsed:se,isWaitingForResponse:_n}}finally{this.currentLLMService=null}}catch(c){if(c instanceof b&&c.code==="aborted")return console.log("MessageProcessor: Processing cancelled by user"),{success:!0,response:"",toolsUsed:[],isWaitingForResponse:!1};let h=c instanceof b&&c.retryable,u=c instanceof Error?c.message:"Unknown error";if(console.error(`MessageProcessor: LLM processing failed (attempt ${d}/${xn}):`,u),s=this.getUserFriendlyError(c),!h||d>=xn)break;let m=Qr*Math.pow(2,d-1);console.log(`MessageProcessor: Retrying in ${m}ms...`),await this.sleep(m)}return{success:!1,error:s||"Unknown error during LLM processing"}}extractToolsUsed(e,t){let n=e.getHistory(),s=new Set;for(let o of n)if(o.role==="assistant"&&Array.isArray(o.content))for(let i of o.content)i.type==="tool_use"&&t.includes(i.name)&&s.add(i.name);return Array.from(s)}sendSuccessNotification(e,t){this.connection.sendNotification(e,{body:t,priority:"normal"})}sendErrorNotification(e,t){this.connection.sendNotification(e,{title:"SmartHole Error",body:t,priority:"high"})}getUserFriendlyError(e){if(e instanceof b)switch(e.code){case"auth_error":return"API key is missing or invalid. Please check your SmartHole settings.";case"rate_limit":return"Too many requests. Please try again in a moment.";case"network":return"Network error. Please check your internet connection.";case"invalid_request":return"Unable to process request. The message may be too long or contain invalid content.";default:return"An unexpected error occurred while processing your request."}return e instanceof Error?e.message:"An unexpected error occurred while processing your request."}sleep(e){return new Promise(t=>setTimeout(t,e))}buildContinuationContext(e){return e.pendingContext?`## Pending Context
You previously asked a question and are awaiting the user's response.
Your question was: "${e.pendingContext.lastAgentMessage}"
The message below is the user's response to your question. Continue the conversation accordingly.`:""}async persistConversationStates(){let e=await this.plugin.loadData()||{};e[Mn]=Object.fromEntries(this.conversationStates),await this.plugin.saveData(e)}async loadConversationStates(){try{let e=await this.plugin.loadData();if(e!=null&&e[Mn]){let t=e[Mn];this.conversationStates=new Map(Object.entries(t)),console.log(`MessageProcessor: Loaded ${this.conversationStates.size} persisted conversation state(s)`)}}catch(e){console.error("MessageProcessor: Failed to load conversation states:",e),this.conversationStates=new Map}}async cleanupStaleStates(){var o,i;let t=((o=this.settings.conversationStateTimeoutMinutes)!=null?o:60)*60*1e3,n=Date.now(),s=0;for(let[a,l]of this.conversationStates)if((i=l.pendingContext)!=null&&i.createdAt){let d=new Date(l.pendingContext.createdAt).getTime();n-d>t&&(this.conversationStates.delete(a),s++)}s>0&&(console.log(`MessageProcessor: Cleaned up ${s} stale conversation state(s)`),await this.persistConversationStates())}};var M=require("obsidian");var $t={"claude-haiku-4-5-20251001":"Claude Haiku 4.5 (Fast, cost-efficient)","claude-sonnet-4-5-20250929":"Claude Sonnet 4.5 (Balanced)","claude-opus-4-5-20251101":"Claude Opus 4.5 (Most capable)"};var Zr=`Review this conversation and reflect on opportunities for improvement. Consider:

1. **System Prompt Improvements**: Were there missing instructions, unclear guidance, or information that should be added to the system prompt to handle this type of request better?

2. **Vault Knowledge Gaps**: What did you not know about the vault's structure, naming conventions, or content that would have helped? Were there files or folders you expected to exist but didn't?

3. **Tooling Opportunities**: Were there actions you wished you could take but couldn't? Tools that would have made the interaction smoother or more effective?

4. **Workflow Improvements**: Could this type of request be handled more efficiently? Are there patterns or shortcuts that would improve the experience?

Provide specific, actionable insights. Focus on what would make future similar conversations more effective.`,eo="Miss Simone - I manage personal notes, journals, lists, and knowledge in Obsidian. I can create notes, update existing ones, search for information, and organize files. Use me for anything related to remembering things, note-taking, or personal knowledge management.",to=`You are Miss Simone, the custodian of this Obsidian vault. You manage the organization, creation, retrieval, and maintenance of all content within.

This is a personal knowledge notebook. Notes can be organized flexibly based on content:

- Daily notes and journals go in the "Journal" folder
- Lists (shopping, todos, etc.) go in the "Lists" folder
- Project-related notes go in the "Projects" folder
- General reference and wiki-style notes go in the root or "Notes" folder

When encountering information that doesn't fit clearly into existing categories, create a new note in the most logical location and use descriptive naming. Prefer linking related notes together using [[wiki links]].

The goal is an evolving personal wiki where information is easy to find and naturally connected.`,ls={enableSmartHoleConnection:!0,anthropicApiKeyName:"",model:"claude-haiku-4-5-20251001",clientName:"obsidian",routingDescription:eo,informationArchitecture:to,maxConversationHistory:50,conversationIdleTimeoutMinutes:30,maxConversationsRetained:1e3,conversationStateTimeoutMinutes:60,enableConversationRetrospection:!1,retrospectionPrompt:Zr},Sn=class extends M.Modal{constructor(e,t){super(e),this.onConfirm=t}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Clear Conversation History"}),e.createEl("p",{text:"This will permanently delete all conversation history. This action cannot be undone."}),new M.Setting(e).addButton(t=>t.setButtonText("Cancel").onClick(()=>this.close())).addButton(t=>t.setButtonText("Clear All").setWarning().onClick(()=>{this.onConfirm(),this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}},Ft=class extends M.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new M.Setting(e).setName("Enable SmartHole Connection").setDesc("Connect to SmartHole desktop app. When disabled, the plugin will not attempt to connect or ping the desktop app.").addToggle(u=>u.setValue(this.plugin.settings.enableSmartHoleConnection).onChange(async m=>{this.plugin.settings.enableSmartHoleConnection=m,await this.plugin.saveSettings(),this.plugin.setSmartHoleConnectionEnabled(m)})),new M.Setting(e).setName("Anthropic API Key").setDesc("Select or create a secret for your Anthropic API key").addComponent(u=>new M.SecretComponent(this.app,u).setValue(this.plugin.settings.anthropicApiKeyName).onChange(async m=>{this.plugin.settings.anthropicApiKeyName=m,await this.plugin.saveSettings()})),new M.Setting(e).setName("Claude Model").setDesc("Select the Claude model to use for processing").addDropdown(u=>{for(let[m,g]of Object.entries($t))u.addOption(m,g);return u.setValue(this.plugin.settings.model).onChange(async m=>{this.plugin.settings.model=m,await this.plugin.saveSettings()})}),new M.Setting(e).setName("Client Name").setDesc("Identifier used when registering with SmartHole (lowercase, no spaces)").addText(u=>u.setPlaceholder("obsidian").setValue(this.plugin.settings.clientName).onChange(async m=>{this.plugin.settings.clientName=m,await this.plugin.saveSettings()}));let t=null;new M.Setting(e).setName("Routing Description").setDesc("Description used by SmartHole to route messages to this client").addTextArea(u=>(u.inputEl.rows=4,u.inputEl.cols=50,t=u.inputEl,u.setValue(this.plugin.settings.routingDescription).onChange(async m=>{this.plugin.settings.routingDescription=m,await this.plugin.saveSettings()}))),new M.Setting(e).setName("Information Architecture").setDesc("Prompt defining how notes should be organized in your vault").addTextArea(u=>(u.inputEl.rows=8,u.inputEl.cols=50,u.setValue(this.plugin.settings.informationArchitecture).onChange(async m=>{this.plugin.settings.informationArchitecture=m,await this.plugin.saveSettings()})));let n=new M.Setting(e).setName("Generate from IA").setDesc("Generate routing description based on your Information Architecture"),s=n.descEl.createSpan();s.style.marginLeft="8px",s.style.fontWeight="500";let o=u=>{s.setText(u),s.style.color="var(--text-error)"},i=u=>{s.setText(u),s.style.color="var(--text-success)"},a=()=>{s.setText(""),s.style.color=""};n.addButton(u=>u.setButtonText("Generate").onClick(async()=>{var g,x,$;if(a(),!((g=this.plugin.settings.anthropicApiKeyName)!=null&&g.trim())){o("Error: API key not configured");return}if(!((x=this.plugin.settings.informationArchitecture)!=null&&x.trim())){o("Error: Information Architecture is empty");return}u.setDisabled(!0);let m=($=u.buttonEl.textContent)!=null?$:"Generate";u.setButtonText("Generating...");try{let A=new J(this.app,this.plugin.settings);await A.initialize();let C=`Analyze the following Information Architecture for an Obsidian vault and generate a concise routing description (under 150 words) that explains what this client can do and when to use it. The description should be in first person and help a routing system decide when to send messages to this client.

Information Architecture:
${this.plugin.settings.informationArchitecture}

Generate only the routing description text, nothing else. Do not include any preamble or explanation.`,D=await A.processMessage(C),H=K(D).trim();if(!H)throw new Error("LLM returned empty response");this.plugin.settings.routingDescription=H,await this.plugin.saveSettings(),t&&(t.value=H),i("Description generated successfully!")}catch(A){let C="Generation failed";(A instanceof b||A instanceof Error)&&(C=A.message),o(`Error: ${C}`)}finally{u.setDisabled(!1),u.setButtonText(m)}})),new M.Setting(e).setName("Conversation History Limit").setDesc("Maximum number of recent conversations to keep in full detail (older ones are summarized)").addText(u=>u.setPlaceholder("50").setValue(String(this.plugin.settings.maxConversationHistory)).onChange(async m=>{let g=parseInt(m,10);!isNaN(g)&&g>0&&(this.plugin.settings.maxConversationHistory=g,await this.plugin.saveSettings())})),new M.Setting(e).setName("Conversation Idle Timeout (minutes)").setDesc("Minutes of inactivity before a conversation is considered ended and a new one begins").addText(u=>u.setPlaceholder("30").setValue(String(this.plugin.settings.conversationIdleTimeoutMinutes)).onChange(async m=>{let g=parseInt(m,10);!isNaN(g)&&g>0&&(this.plugin.settings.conversationIdleTimeoutMinutes=g,await this.plugin.saveSettings())})),new M.Setting(e).setName("Enable Conversation Retrospection").setDesc("When enabled, the LLM will reflect on each completed conversation and log insights to .smarthole/retrospection.md").addToggle(u=>u.setValue(this.plugin.settings.enableConversationRetrospection).onChange(async m=>{this.plugin.settings.enableConversationRetrospection=m,await this.plugin.saveSettings()})),new M.Setting(e).setName("Retrospection Prompt").setDesc("Prompt used when reflecting on completed conversations").addTextArea(u=>(u.inputEl.rows=8,u.inputEl.cols=50,u.setValue(this.plugin.settings.retrospectionPrompt).onChange(async m=>{this.plugin.settings.retrospectionPrompt=m,await this.plugin.saveSettings()}))),new M.Setting(e).setName("Max Conversations Retained").setDesc("Maximum number of conversations to keep (oldest are deleted when this limit is exceeded)").addText(u=>u.setPlaceholder("1000").setValue(String(this.plugin.settings.maxConversationsRetained)).onChange(async m=>{let g=parseInt(m,10);!isNaN(g)&&g>=1&&(this.plugin.settings.maxConversationsRetained=g,await this.plugin.saveSettings())}));let l=new M.Setting(e).setName("Clear Conversation History").setDesc("Permanently delete all conversation history"),d=l.descEl.createSpan();d.style.marginLeft="8px",d.style.fontWeight="500";let c=u=>{d.setText(u),d.style.color="var(--text-error)"},p=u=>{d.setText(u),d.style.color="var(--text-success)"},h=()=>{d.setText(""),d.style.color=""};l.addButton(u=>u.setButtonText("Clear All").setWarning().onClick(()=>{h(),new Sn(this.app,async()=>{try{let m=this.plugin.getConversationManager();if(!m){c("Error: ConversationManager unavailable");return}await m.clearAll(),p("Conversation history cleared")}catch(m){let g=m instanceof Error?m.message:"Unknown error";c(`Error: ${g}`)}}).open()}))}};var U=require("obsidian");var Me="smarthole-chat-view",Je=class extends U.ItemView{constructor(t,n){super(t);this.messages=[];this.messagesEl=null;this.inputEl=null;this.typingEl=null;this.onSendCallback=null;this.unsubscribe=null;this.unsubscribeMessageReceived=null;this.unsubscribeAgentMessage=null;this.unsubscribeRetrospection=null;this.renderedMessageIds=new Set;this.messageElements=new Map;this.editingMessageId=null;this.isProcessing=!1;this.sendButton=null;this.stopButton=null;this.plugin=n}getViewType(){return Me}getDisplayText(){return"SmartHole Chat"}getIcon(){return"message-circle"}async onOpen(){let t=this.containerEl.children[1];t.empty();let n=t.createEl("div",{cls:"smarthole-chat-container"}),s=n.createEl("div",{cls:"smarthole-chat-header"});s.createEl("span",{cls:"smarthole-chat-header-title"}).setText("SmartHole Chat");let i=s.createEl("select",{cls:"smarthole-chat-model-select"});for(let[c,p]of Object.entries($t)){let h=i.createEl("option",{value:c}),u=p.replace(/^Claude\s+/,"").replace(/\s*\(.*\)$/,"");h.setText(u)}i.value=this.plugin.settings.model,i.addEventListener("change",async()=>{this.plugin.settings.model=i.value,await this.plugin.saveSettings()}),this.messagesEl=n.createEl("div",{cls:"smarthole-chat-messages"});let a=n.createEl("div",{cls:"smarthole-chat-input-area"});this.inputEl=a.createEl("textarea",{cls:"smarthole-chat-input",attr:{placeholder:"Type a message..."}}),this.sendButton=a.createEl("button",{cls:"smarthole-chat-send"}),(0,U.setIcon)(this.sendButton,"send"),this.stopButton=a.createEl("button",{cls:"smarthole-chat-stop"}),(0,U.setIcon)(this.stopButton,"square"),this.stopButton.style.display="none",this.stopButton.addEventListener("click",()=>{this.isProcessing&&(this.plugin.cancelCurrentProcessing(),this.setProcessingState(!1))}),this.inputEl.addEventListener("keydown",c=>{if(c.key==="Escape"&&this.editingMessageId){c.preventDefault(),this.cancelEditMode();return}c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),this.handleSend())}),this.sendButton.addEventListener("click",()=>{this.handleSend()}),this.inputEl.addEventListener("input",()=>{this.autoResizeTextarea()}),this.inputEl.addEventListener("dragover",c=>{c.preventDefault()}),this.inputEl.addEventListener("drop",c=>{var h,u;let p=(u=(h=c.dataTransfer)==null?void 0:h.getData("text/plain"))!=null?u:"";if(p.startsWith("obsidian://")){c.preventDefault(),c.stopPropagation();try{let g=new URL(p).searchParams.get("file");g&&this.insertAtCursor(g)}catch(m){this.insertAtCursor(p)}}});let l=this.plugin.getConversationManager(),d=l==null?void 0:l.getActiveConversation();if(d)for(let c of d.messages)await this.addMessage({id:c.id,role:c.role,content:c.content,timestamp:c.timestamp,toolsUsed:c.toolsUsed});this.unsubscribe=this.plugin.onMessageResponse(c=>{var p;this.addMessage({id:c.messageId,role:"assistant",content:c.success?(p=c.response)!=null?p:"No response":`Error: ${c.error}`,timestamp:new Date().toISOString(),toolsUsed:c.toolsUsed}),this.setProcessingState(!1)}),this.unsubscribeMessageReceived=this.plugin.onMessageReceived(c=>{var p;((p=c.payload.metadata)==null?void 0:p.source)!=="direct"&&(this.addMessage({id:c.payload.id,role:"user",content:c.payload.text,timestamp:c.payload.timestamp,source:"websocket"}),this.showTypingIndicator())}),this.unsubscribeAgentMessage=this.plugin.onAgentMessage(c=>{this.addMessage({id:`agent-${crypto.randomUUID()}`,role:"assistant",content:c.content,timestamp:c.timestamp})}),this.unsubscribeRetrospection=this.plugin.onRetrospection(c=>{this.addMessage({id:`retrospection-${crypto.randomUUID()}`,role:"assistant",content:c.content,timestamp:c.timestamp,type:"retrospection",conversationTitle:c.conversationTitle})}),this.setOnSendCallback(async c=>{this.addMessage({id:crypto.randomUUID(),role:"user",content:c,timestamp:new Date().toISOString(),source:"direct"}),this.showTypingIndicator();try{await this.plugin.processDirectMessage(c)}catch(p){this.setProcessingState(!1),this.addMessage({id:crypto.randomUUID(),role:"assistant",content:`Error: ${p instanceof Error?p.message:"Unknown error"}`,timestamp:new Date().toISOString()})}})}async onClose(){var t,n,s,o;(t=this.unsubscribe)==null||t.call(this),this.unsubscribe=null,(n=this.unsubscribeMessageReceived)==null||n.call(this),this.unsubscribeMessageReceived=null,(s=this.unsubscribeAgentMessage)==null||s.call(this),this.unsubscribeAgentMessage=null,(o=this.unsubscribeRetrospection)==null||o.call(this),this.unsubscribeRetrospection=null,this.messages=[],this.renderedMessageIds.clear(),this.messageElements.clear(),this.editingMessageId=null,this.messagesEl=null,this.inputEl=null,this.typingEl=null,this.onSendCallback=null,this.sendButton=null,this.stopButton=null,this.isProcessing=!1}setOnSendCallback(t){this.onSendCallback=t}async addMessage(t){this.renderedMessageIds.has(t.id)||(this.renderedMessageIds.add(t.id),this.messages.push(t),await this.renderMessage(t),this.scrollToBottom())}showTypingIndicator(){!this.messagesEl||this.typingEl||(this.typingEl=this.messagesEl.createEl("div",{cls:"smarthole-chat-typing"}),this.typingEl.setText("Thinking..."),this.scrollToBottom(),this.setProcessingState(!0))}hideTypingIndicator(){this.typingEl&&(this.typingEl.remove(),this.typingEl=null)}setProcessingState(t){this.isProcessing=t,this.sendButton&&(this.sendButton.style.display=t?"none":"flex"),this.stopButton&&(this.stopButton.style.display=t?"flex":"none"),t||this.hideTypingIndicator()}clearMessages(){this.messages=[],this.renderedMessageIds.clear(),this.messageElements.clear(),this.editingMessageId=null,this.messagesEl&&this.messagesEl.empty()}async handleSend(){if(!this.inputEl)return;let t=this.inputEl.value.trim();if(t){if(this.editingMessageId){let n=this.editingMessageId,s=this.messages.find(o=>o.id===n);if(this.clearEditState(),s)try{let o=this.plugin.getConversationManager();if(o){let i=this.findConversationMessageId(o,s);if(i){let{forkPoint:a}=await o.forkConversation(i);this.removeMessagesFromIndex(a)}else{let a=this.messages.findIndex(l=>l.id===n);a!==-1&&this.removeMessagesFromIndex(a)}}}catch(o){console.error("SmartHole Chat: Failed to fork conversation",o)}}this.inputEl.value="",this.autoResizeTextarea(),this.onSendCallback?this.onSendCallback(t):console.log("SmartHole Chat: Message sent (no handler set)",t)}}findConversationMessageId(t,n){var i;let s=t.getActiveConversation();if(!s)return null;let o=s.messages.find(a=>a.role===n.role&&a.content===n.content);return(i=o==null?void 0:o.id)!=null?i:null}clearEditState(){if(!this.editingMessageId)return;let t=this.messageElements.get(this.editingMessageId);t&&t.removeClass("smarthole-chat-message-editing"),this.editingMessageId=null}formatTimestamp(t){let n=new Date(t),s=new Date,o=s.getTime()-n.getTime(),i=Math.floor(o/6e4);return i<1?"just now":i<60?`${i}m ago`:n.toDateString()===s.toDateString()?n.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}):n.toLocaleDateString([],{month:"short",day:"numeric"})+" "+n.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}async renderMessage(t){if(!this.messagesEl)return;let n=t.type==="retrospection",s=n?"smarthole-chat-message-retrospection":`smarthole-chat-message-${t.role}`,o=this.messagesEl.createEl("div",{cls:`smarthole-chat-message ${s}`});this.messageElements.set(t.id,o);let i=o.createEl("div",{cls:"smarthole-chat-message-header"}),a=i.createEl("span",{cls:"smarthole-chat-message-role"}),l=n?t.conversationTitle?`Retrospection: ${t.conversationTitle}`:"Retrospection":t.role==="user"?"You":"Assistant";a.setText(l),i.createEl("span",{cls:"smarthole-chat-message-timestamp"}).setText(this.formatTimestamp(t.timestamp));let c=o.createEl("div",{cls:"smarthole-chat-message-content markdown-rendered"});if(await U.MarkdownRenderer.render(this.app,t.content,c,"",this),!n&&t.role==="user"&&t.source&&o.createEl("div",{cls:"smarthole-chat-source"}).setText(t.source==="direct"?"typed":"voice"),!n&&t.role==="assistant"&&t.toolsUsed&&t.toolsUsed.length>0){let u=o.createEl("details",{cls:"smarthole-chat-tools"});u.createEl("summary").setText(`Tools used (${t.toolsUsed.length})`);let g=u.createEl("ul",{cls:"smarthole-chat-tools-list"});for(let x of t.toolsUsed)g.createEl("li").setText(x)}let p=o.createEl("div",{cls:"smarthole-chat-message-footer"});if(!n&&t.role==="user"){let u=p.createEl("button",{cls:"smarthole-chat-action-btn",attr:{"data-message-id":t.id,"aria-label":"Edit message"}});(0,U.setIcon)(u,"pencil"),u.addEventListener("click",()=>{this.enterEditMode(t.id)})}let h=p.createEl("button",{cls:"smarthole-chat-action-btn",attr:{"aria-label":"Copy message"}});(0,U.setIcon)(h,"copy"),h.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(t.content),(0,U.setIcon)(h,"check"),setTimeout(()=>{(0,U.setIcon)(h,"copy")},1500)}catch(u){console.warn("SmartHole Chat: Failed to copy message to clipboard",u)}})}enterEditMode(t){let n=this.messages.find(o=>o.id===t);if(!n||!this.inputEl)return;this.editingMessageId=t,this.inputEl.value=n.content,this.autoResizeTextarea(),this.inputEl.focus(),this.inputEl.setSelectionRange(0,n.content.length);let s=this.messageElements.get(t);s&&s.addClass("smarthole-chat-message-editing")}cancelEditMode(){if(!this.editingMessageId)return;let t=this.messageElements.get(this.editingMessageId);t&&t.removeClass("smarthole-chat-message-editing"),this.editingMessageId=null,this.inputEl&&(this.inputEl.value="",this.autoResizeTextarea())}removeMessagesFromIndex(t){if(!this.messagesEl||t<0||t>=this.messages.length)return;let n=this.messages.slice(t);for(let s of n){this.renderedMessageIds.delete(s.id);let o=this.messageElements.get(s.id);o&&o.remove(),this.messageElements.delete(s.id)}this.messages=this.messages.slice(0,t)}scrollToBottom(){this.messagesEl&&this.messagesEl.scrollTo({top:this.messagesEl.scrollHeight,behavior:"smooth"})}autoResizeTextarea(){this.inputEl&&(this.inputEl.style.height="auto",this.inputEl.style.height=`${this.inputEl.scrollHeight}px`)}insertAtCursor(t){if(!this.inputEl)return;let n=this.inputEl.selectionStart,s=this.inputEl.selectionEnd,o=this.inputEl.value;this.inputEl.value=o.slice(0,n)+t+o.slice(s),this.inputEl.selectionStart=this.inputEl.selectionEnd=n+t.length,this.inputEl.focus(),this.autoResizeTextarea()}};function us(r){return r.type==="registration_response"}function ds(r){return r.type==="message"}function ps(r){return r.success===!0}function ms(r){return r.success===!1}function Cn(r){return typeof r=="object"&&r!==null&&"type"in r&&typeof r.type=="string"&&"payload"in r&&typeof r.payload=="object"&&r.payload!==null}function hs(r){return Cn(r)?r.type==="registration_response"||r.type==="message":!1}var no="ws://127.0.0.1:9473",so=1e3,ro=3e4,Dt=class{constructor(e){this.ws=null;this.state="disconnected";this.reconnectionEnabled=!1;this.reconnectAttempts=0;this.reconnectTimeoutId=null;this.onStateChange=null;this.onRegistrationResult=null;this.onMessage=null;this.onError=null;this.options={name:e.name,description:e.description,version:e.version,capabilities:e.capabilities}}getState(){return this.state}enableReconnection(){this.reconnectionEnabled=!0}disableReconnection(){this.reconnectionEnabled=!1,this.cancelPendingReconnect()}isReconnecting(){return this.reconnectTimeoutId!==null}getReconnectAttempts(){return this.reconnectAttempts}connect(){if(this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)){console.warn("SmartHoleConnection: Already connected or connecting");return}this.setState("connecting");try{this.ws=new WebSocket(no),this.setupEventHandlers()}catch(e){this.setState("error"),this.emitError(e instanceof Error?e:new Error(String(e)))}}disconnect(){this.disableReconnection(),this.ws&&(this.ws.onopen=null,this.ws.onclose=null,this.ws.onerror=null,this.ws.onmessage=null,(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)&&this.ws.close(1e3,"Client disconnect"),this.ws=null,this.setState("disconnected"))}sendAck(e){this.sendResponse({type:"response",payload:{messageId:e,type:"ack",payload:{}}})}sendReject(e,t){this.sendResponse({type:"response",payload:{messageId:e,type:"reject",payload:t?{reason:t}:{}}})}sendNotification(e,t){let n={};t.title!==void 0&&(n.title=t.title),t.body!==void 0&&(n.body=t.body),t.priority!==void 0&&(n.priority=t.priority),this.sendResponse({type:"response",payload:{messageId:e,type:"notification",payload:n}})}setState(e){var t;this.state!==e&&(this.state=e,(t=this.onStateChange)==null||t.call(this,e))}setupEventHandlers(){this.ws&&(this.ws.onopen=()=>{this.sendRegistration()},this.ws.onclose=e=>{this.ws&&(console.log(`SmartHoleConnection: WebSocket closed (code: ${e.code}, reason: ${e.reason})`),this.ws=null,this.setState("disconnected"),this.scheduleReconnect())},this.ws.onerror=e=>{console.error("SmartHoleConnection: WebSocket error",e),this.setState("error"),this.emitError(new Error("WebSocket connection error"))},this.ws.onmessage=e=>{this.handleMessage(e.data)})}sendRegistration(){let e={type:"registration",payload:{name:this.options.name,description:this.options.description,...this.options.version&&{version:this.options.version},...this.options.capabilities&&{capabilities:this.options.capabilities}}};this.send(e)}handleMessage(e){var n;let t;try{if(typeof e!="string"){console.warn("SmartHoleConnection: Received non-string message, ignoring");return}t=JSON.parse(e)}catch(s){console.warn("SmartHoleConnection: Failed to parse message as JSON",s);return}if(!Cn(t)){console.warn("SmartHoleConnection: Received malformed protocol message",t);return}if(!hs(t)){console.warn(`SmartHoleConnection: Received unknown message type: ${t.type}`);return}if(us(t)){this.handleRegistrationResponse(t.payload);return}if(ds(t)){(n=this.onMessage)==null||n.call(this,t);return}}handleRegistrationResponse(e){var t,n;ps(e)?(console.log(`SmartHoleConnection: Registration successful (clientId: ${e.clientId})`),this.setState("connected"),this.resetReconnectState(),(t=this.onRegistrationResult)==null||t.call(this,!0)):ms(e)&&(console.error(`SmartHoleConnection: Registration failed (${e.code}): ${e.message}`),this.setState("error"),(n=this.onRegistrationResult)==null||n.call(this,!1,{code:e.code,message:e.message}),this.ws&&this.ws.close(4e3,"Registration failed"))}sendResponse(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("SmartHoleConnection: Cannot send response, WebSocket not open");return}this.send(e)}send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("SmartHoleConnection: Cannot send message, WebSocket not open");return}try{this.ws.send(JSON.stringify(e))}catch(t){console.error("SmartHoleConnection: Failed to send message",t),this.emitError(t instanceof Error?t:new Error(String(t)))}}emitError(e){var t;(t=this.onError)==null||t.call(this,e)}calculateReconnectDelay(){return Math.min(so*Math.pow(2,this.reconnectAttempts),ro)}cancelPendingReconnect(){this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null)}scheduleReconnect(){if(!this.reconnectionEnabled)return;this.cancelPendingReconnect();let e=this.calculateReconnectDelay();console.log(`SmartHoleConnection: Reconnecting in ${e/1e3}s (attempt ${this.reconnectAttempts+1})`),this.reconnectTimeoutId=setTimeout(()=>{this.reconnectTimeoutId=null,this.reconnectAttempts++,this.connect()},e)}resetReconnectState(){this.reconnectAttempts=0,this.cancelPendingReconnect()}};var Ht=class extends fs.Plugin{constructor(){super(...arguments);this.connection=null;this.inboxManager=null;this.messageProcessor=null;this.conversationManager=null}async onload(){await this.loadSettings(),this.addSettingTab(new Ft(this.app,this)),this.statusBarEl=this.addStatusBarItem(),this.updateStatusBar("disconnected"),this.registerView(Me,t=>new Je(t,this)),this.addRibbonIcon("message-circle","Open SmartHole Chat",()=>{this.activateChatView()}),this.addCommand({id:"open-chat",name:"Open Chat",callback:()=>this.activateChatView()}),this.statusBarEl.addEventListener("click",()=>{console.log("SmartHole connection status clicked")}),this.connection=new Dt({name:this.settings.clientName,description:this.settings.routingDescription,version:this.manifest.version}),this.connection.onStateChange=t=>{this.updateStatusBar(t)},this.inboxManager=new Ge(this.app.vault),this.conversationManager=new Ve(this),await this.conversationManager.load(),this.messageProcessor=new Ke({connection:this.connection,inboxManager:this.inboxManager,app:this.app,settings:this.settings,conversationManager:this.conversationManager,plugin:this}),await this.messageProcessor.initialize(),this.registerInterval(window.setInterval(()=>{var t;(t=this.messageProcessor)==null||t.cleanupStaleStates()},15*60*1e3)),this.connection.onMessage=async t=>{let n=await this.messageProcessor.process(t);n.success||console.error("SmartHole: Message processing failed",n.error)},this.settings.enableSmartHoleConnection?(this.connection.enableReconnection(),this.connection.connect()):this.updateStatusBar("disabled"),this.messageProcessor.reprocessPending().catch(t=>{console.error("SmartHole: Failed to reprocess pending messages",t)}),console.log("SmartHole Client plugin loaded")}onunload(){this.connection&&(this.connection.disableReconnection(),this.connection.disconnect(),this.connection=null),this.inboxManager=null,this.messageProcessor=null,this.conversationManager=null,console.log("SmartHole Client plugin unloaded")}getConversationManager(){return this.conversationManager}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},ls,this.extractSettings(t))}async saveSettings(){let n={...await this.loadData()||{},...this.settings};await this.saveData(n)}extractSettings(t){if(!t||typeof t!="object")return{};let n=t,s={};return typeof n.enableSmartHoleConnection=="boolean"&&(s.enableSmartHoleConnection=n.enableSmartHoleConnection),typeof n.anthropicApiKeyName=="string"&&(s.anthropicApiKeyName=n.anthropicApiKeyName),typeof n.model=="string"&&(s.model=n.model),typeof n.clientName=="string"&&(s.clientName=n.clientName),typeof n.routingDescription=="string"&&(s.routingDescription=n.routingDescription),typeof n.informationArchitecture=="string"&&(s.informationArchitecture=n.informationArchitecture),typeof n.maxConversationHistory=="number"&&(s.maxConversationHistory=n.maxConversationHistory),typeof n.conversationIdleTimeoutMinutes=="number"&&(s.conversationIdleTimeoutMinutes=n.conversationIdleTimeoutMinutes),typeof n.maxConversationsRetained=="number"&&(s.maxConversationsRetained=n.maxConversationsRetained),typeof n.conversationStateTimeoutMinutes=="number"&&(s.conversationStateTimeoutMinutes=n.conversationStateTimeoutMinutes),typeof n.enableConversationRetrospection=="boolean"&&(s.enableConversationRetrospection=n.enableConversationRetrospection),typeof n.retrospectionPrompt=="string"&&(s.retrospectionPrompt=n.retrospectionPrompt),s}updateStatusBar(t){let n={disconnected:"SmartHole: Disconnected",connecting:"SmartHole: Connecting...",connected:"SmartHole: Connected",error:"SmartHole: Error",disabled:"SmartHole: Disabled"};this.statusBarEl.setText(n[t])}setSmartHoleConnectionEnabled(t){var n,s,o,i;t?((n=this.connection)==null||n.enableReconnection(),(s=this.connection)==null||s.connect()):((o=this.connection)==null||o.disableReconnection(),(i=this.connection)==null||i.disconnect(),this.updateStatusBar("disabled"))}async activateChatView(){let{workspace:t}=this.app,n=null,s=t.getLeavesOfType(Me);s.length>0?n=s[0]:(n=t.getRightLeaf(!1),n&&await n.setViewState({type:Me,active:!0})),n&&t.revealLeaf(n)}async processDirectMessage(t){if(!this.messageProcessor)throw new Error("MessageProcessor not initialized");let n={type:"message",payload:{id:crypto.randomUUID(),text:t,timestamp:new Date().toISOString(),metadata:{inputMethod:"text",source:"direct"}}};await this.messageProcessor.process(n,!0)}cancelCurrentProcessing(){var t;(t=this.messageProcessor)==null||t.cancelCurrentProcessing()}onMessageResponse(t){return this.messageProcessor?this.messageProcessor.onResponse(t):()=>{}}onMessageReceived(t){return this.messageProcessor?this.messageProcessor.onMessageReceived(t):()=>{}}onAgentMessage(t){return this.messageProcessor?this.messageProcessor.onAgentMessage(t):()=>{}}onRetrospection(t){return this.messageProcessor?this.messageProcessor.onRetrospection(t):()=>{}}};
